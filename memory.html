<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="strict-origin-when-cross-origin">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.gstatic.com; frame-src https://accounts.google.com https://*.firebaseapp.com; font-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self'">
<title>Memory Bank -- FPCS Knowledge System</title>
<link rel="stylesheet" href="css/core.css">
<link rel="stylesheet" href="css/nav.css">
<link rel="stylesheet" href="css/auth.css">
<style>
  /* CHART STYLES */
  .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .chart-box { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
  .chart-box h3 { font-size: 14px; color: var(--accent); margin-bottom: 12px; }
  .chart-box canvas { width: 100% !important; height: 280px !important; display: block; }
  /* LAYER ARCHITECTURE */
  .layer-diagram { display: flex; flex-direction: column; gap: 4px; }
  .layer-row { display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border); transition: all 0.2s; }
  .layer-row:hover { border-color: var(--accent); background: rgba(56,189,248,0.04); }
  .layer-num { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; flex-shrink: 0; }
  .layer-name { font-weight: 700; font-size: 14px; min-width: 100px; }
  .layer-desc { font-size: 12px; color: var(--muted); flex: 1; }
  .layer-example { font-size: 11px; font-family: monospace; color: var(--yellow); background: rgba(251,191,36,0.08); padding: 2px 8px; border-radius: 4px; }
  .l0 { background: #7c3aed20; color: #a78bfa; border-color: #7c3aed40; } .l0 .layer-num { background: #7c3aed; color: #fff; }
  .l1 { background: #3b82f610; color: #60a5fa; border-color: #3b82f630; } .l1 .layer-num { background: #3b82f6; color: #fff; }
  .l2 { background: #22c55e10; color: #4ade80; border-color: #22c55e30; } .l2 .layer-num { background: #22c55e; color: #fff; }
  .l3 { background: #f9731610; color: #fb923c; border-color: #f9731630; } .l3 .layer-num { background: #f97316; color: #fff; }
  .l4 { background: #ef444410; color: #f87171; border-color: #ef444430; } .l4 .layer-num { background: #ef4444; color: #fff; }
  .l5 { background: #06b6d410; color: #22d3ee; border-color: #06b6d430; } .l5 .layer-num { background: #06b6d4; color: #fff; }
  .l6 { background: #64748b10; color: #94a3b8; border-color: #64748b30; } .l6 .layer-num { background: #64748b; color: #fff; }
  /* NARROWING DEMO */
  .narrow-step { display: flex; align-items: center; gap: 12px; margin-bottom: 6px; }
  .narrow-bar-wrap { flex: 1; height: 28px; background: var(--bg); border-radius: 4px; overflow: hidden; border: 1px solid var(--border); position: relative; }
  .narrow-bar { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.4,0,0.2,1); position: relative; }
  .narrow-bar span { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: 700; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
  .narrow-label { font-size: 12px; color: var(--muted); min-width: 180px; white-space: nowrap; }
  .narrow-count { font-size: 14px; font-weight: 700; color: var(--text); min-width: 70px; text-align: right; }
  /* RESULTS TABLE */
  .sim-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .sim-table th { text-align: left; padding: 8px 12px; color: var(--accent); border-bottom: 2px solid var(--border); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
  .sim-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); }
  .sim-table tr:hover td { background: rgba(56,189,248,0.04); }
  .sim-table .num { text-align: right; font-family: monospace; font-weight: 600; }
  .sim-table .highlight { color: var(--green); font-weight: 700; }
  /* DEMO INPUT */
  .demo-input { display: flex; gap: 12px; margin-bottom: 16px; }
  .demo-input input { flex: 1; background: var(--bg); border: 2px solid var(--border); border-radius: 8px; padding: 10px 16px; color: var(--text); font-size: 14px; outline: none; }
  .demo-input input:focus { border-color: var(--accent); }
  .demo-input select { background: var(--bg); border: 2px solid var(--border); border-radius: 8px; padding: 10px 12px; color: var(--text); font-size: 13px; }
  .demo-input button { background: var(--green); color: #000; border: none; border-radius: 8px; padding: 10px 20px; font-weight: 700; cursor: pointer; }
  .demo-input button:hover { opacity: 0.85; }
  .connector { width: 2px; height: 12px; background: var(--border); margin-left: 15px; }
  @media (max-width: 900px) { .chart-row { grid-template-columns: 1fr; } }
</style>
</head>
<body class="theme-memory">
<div id="dashContent">

<!-- HEADER -->
<div class="header" id="top">
  <h1>&#128218; Memory Bank &mdash; Hierarchical Knowledge System</h1>
  <div class="subtitle">7-layer indexed memory with progressive narrowing &bull; Simulation-proven &bull; Page 4 of FPCS Dashboard</div>
</div>

<div class="container">

  <!-- OVERVIEW STATS -->
  <div class="grid">
    <div class="stat-card">
      <div class="label">Architecture</div>
      <div class="value" style="color:var(--green)">7</div>
      <div class="sub">Hierarchical Layers</div>
    </div>
    <div class="stat-card">
      <div class="label">Max Speedup</div>
      <div class="value" style="color:var(--yellow)">41x</div>
      <div class="sub">Operations at 10K scale</div>
    </div>
    <div class="stat-card">
      <div class="label">Narrowing Ratio</div>
      <div class="value" style="color:var(--purple)">2,193x</div>
      <div class="sub">Search space reduction @ 10K</div>
    </div>
    <div class="stat-card">
      <div class="label">Simulation Trials</div>
      <div class="value" style="color:var(--accent)">4,000</div>
      <div class="sub">1,000 per scale level</div>
    </div>
    <div class="stat-card">
      <div class="label">Cache Hit Rate</div>
      <div class="value" style="color:var(--orange)">19.2%</div>
      <div class="sub">At 10K entries</div>
    </div>
    <div class="stat-card">
      <div class="label">Keyword Pool</div>
      <div class="value" style="color:var(--pink)">62</div>
      <div class="sub">Indexed search terms</div>
    </div>
  </div>

  <!-- 7-LAYER ARCHITECTURE -->
  <div class="section" id="sec-arch">
    <h2>&#127959; 7-Layer Hierarchical Architecture</h2>
    <p style="color:var(--muted);font-size:13px;margin-bottom:16px">Each layer narrows the search space exponentially. Like a library: Building &rarr; Floor &rarr; Section &rarr; Shelf &rarr; Tote &rarr; Folder &rarr; Item</p>
    <div class="layer-diagram">
      <div class="layer-row l0"><div class="layer-num">0</div><div class="layer-name" style="color:#a78bfa">UNIVERSE</div><div class="layer-desc">The entire memory bank</div><div class="layer-example">memory_bank.json</div></div>
      <div class="connector"></div>
      <div class="layer-row l1"><div class="layer-num">1</div><div class="layer-name" style="color:#60a5fa">DOMAIN</div><div class="layer-desc">Top-level category</div><div class="layer-example">tax | bots | infra | sessions</div></div>
      <div class="connector"></div>
      <div class="layer-row l2"><div class="layer-num">2</div><div class="layer-name" style="color:#4ade80">CONTEXT</div><div class="layer-desc">Temporal/project context</div><div class="layer-example">2022 | 2023 | 2024 | general</div></div>
      <div class="connector"></div>
      <div class="layer-row l3"><div class="layer-num">3</div><div class="layer-name" style="color:#fb923c">TOPIC</div><div class="layer-desc">Subject area</div><div class="layer-example">income | deductions | bot-fleet</div></div>
      <div class="connector"></div>
      <div class="layer-row l4"><div class="layer-num">4</div><div class="layer-name" style="color:#f87171">CONTAINER</div><div class="layer-desc">Data source grouping</div><div class="layer-example">qbo-data | ledger | invoices</div></div>
      <div class="connector"></div>
      <div class="layer-row l5"><div class="layer-num">5</div><div class="layer-name" style="color:#22d3ee">SEGMENT</div><div class="layer-desc">Conversation/document chunk</div><div class="layer-example">seg-0001 | seg-0042</div></div>
      <div class="connector"></div>
      <div class="layer-row l6"><div class="layer-num">6</div><div class="layer-name" style="color:#94a3b8">ENTRY</div><div class="layer-desc">Single fact, message, or data point</div><div class="layer-example">ent-000001 (indexed, keyword-tagged)</div></div>
    </div>
  </div>

  <!-- INDEX STRATEGY -->
  <div class="section">
    <h2>&#128269; Giant Index &mdash; O(1) Lookup Strategy</h2>
    <div class="chart-row">
      <div class="chart-box">
        <h3>Keyword Index</h3>
        <p style="color:var(--muted);font-size:12px;margin-bottom:8px">Every entry tagged with 1-5 keywords. Hash map gives O(1) lookup to entry IDs.</p>
        <div style="font-family:monospace;font-size:11px;color:var(--green);background:var(--bg);padding:12px;border-radius:8px;border:1px solid var(--border);line-height:1.8">
          <span style="color:var(--yellow)">"ebay"</span> &rarr; [ent-001, ent-047, ent-203]<br>
          <span style="color:var(--yellow)">"deduction"</span> &rarr; [ent-005, ent-006, ent-089, ...]<br>
          <span style="color:var(--yellow)">"forensicbot"</span> &rarr; [ent-400, ent-401, ent-402]<br>
          <span style="color:var(--muted)">// 62 keywords, each pointing to entry IDs</span>
        </div>
      </div>
      <div class="chart-box">
        <h3>Speaker Split</h3>
        <p style="color:var(--muted);font-size:12px;margin-bottom:8px">Instantly halves search space by filtering user vs AI messages.</p>
        <div style="font-family:monospace;font-size:11px;color:var(--green);background:var(--bg);padding:12px;border-radius:8px;border:1px solid var(--border);line-height:1.8">
          <span style="color:var(--accent)">"user"</span> &rarr; [ent-002, ent-004, ent-006, ...]<br>
          <span style="color:var(--purple)">"ai"</span> &rarr; [ent-001, ent-003, ent-005, ...]<br>
          <span style="color:var(--muted)">// ~50/50 split, immediate 2x reduction</span><br>
          <br>
          <span style="color:var(--yellow)">"idMap"</span> &rarr; { path, keywords, speaker, date }<br>
          <span style="color:var(--muted)">// Direct O(1) path resolution per entry</span>
        </div>
      </div>
    </div>
  </div>

  <!-- SIMULATION RESULTS -->
  <div class="section" id="sec-sim">
    <h2>&#128200; Simulation Results &mdash; 4,000 Trials</h2>
    <p style="color:var(--muted);font-size:13px;margin-bottom:16px">100 iterations &times; 10 variations per scale. Random 1-3 keyword queries with optional speaker filter.</p>

    <!-- Results Table -->
    <table class="sim-table">
      <thead>
        <tr>
          <th>Scale</th>
          <th class="num">Flat Ops</th>
          <th class="num">Hier Ops</th>
          <th class="num">Speedup</th>
          <th class="num">Narrowing</th>
          <th class="num">Cache Hit</th>
          <th class="num">Flat Time</th>
          <th class="num">Hier Time</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>10 entries</td>
          <td class="num">38</td><td class="num">3</td>
          <td class="num highlight">14x</td><td class="num">4x</td>
          <td class="num">0.3%</td>
          <td class="num">0.005ms</td><td class="num">0.002ms</td>
        </tr>
        <tr>
          <td>100 entries</td>
          <td class="num">327</td><td class="num">10</td>
          <td class="num highlight">37x</td><td class="num">53x</td>
          <td class="num">0.4%</td>
          <td class="num">0.042ms</td><td class="num">0.007ms</td>
        </tr>
        <tr>
          <td>1,000 entries</td>
          <td class="num">3,274</td><td class="num">81</td>
          <td class="num highlight">41x</td><td class="num" style="color:var(--yellow)">391x</td>
          <td class="num">4.1%</td>
          <td class="num">0.494ms</td><td class="num">0.053ms</td>
        </tr>
        <tr style="background:rgba(74,222,128,0.06)">
          <td><strong>10,000 entries</strong></td>
          <td class="num"><strong>33,284</strong></td><td class="num"><strong>814</strong></td>
          <td class="num highlight"><strong>41x</strong></td><td class="num" style="color:var(--green);font-weight:700">2,193x</td>
          <td class="num"><strong>19.2%</strong></td>
          <td class="num"><strong>5.498ms</strong></td><td class="num"><strong>0.796ms</strong></td>
        </tr>
      </tbody>
    </table>

    <!-- CHARTS -->
    <div style="margin-top:24px">
      <div class="chart-row">
        <div class="chart-box">
          <h3>Operations: Flat vs Hierarchical</h3>
          <canvas id="chartOps"></canvas>
        </div>
        <div class="chart-box">
          <h3>Speedup &amp; Narrowing Ratio by Scale</h3>
          <canvas id="chartSpeedup"></canvas>
        </div>
      </div>
      <div class="chart-row" style="margin-top:16px">
        <div class="chart-box">
          <h3>Time Comparison (ms)</h3>
          <canvas id="chartTime"></canvas>
        </div>
        <div class="chart-box">
          <h3>Progressive Narrowing Waterfall (10K scale)</h3>
          <canvas id="chartNarrow"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- LIVE NARROWING DEMO -->
  <div class="section" id="sec-demo">
    <h2>&#9889; Live Narrowing Demo</h2>
    <p style="color:var(--muted);font-size:13px;margin-bottom:16px">See how the 7-layer system narrows 10,000 entries to a handful. Enter keywords and watch the funnel.</p>
    <div class="demo-input">
      <input type="text" id="demoQuery" placeholder="Enter keywords (e.g., ebay income)" value="ebay income">
      <select id="demoSpeaker">
        <option value="">All Speakers</option>
        <option value="user">User Only</option>
        <option value="ai" selected>AI Only</option>
      </select>
      <button onclick="runNarrowingDemo()">&#9889; Run Lookup</button>
    </div>
    <div id="narrowingViz"></div>
  </div>

  <!-- HOW IT WORKS -->
  <div class="section">
    <h2>&#128736; How It Works &mdash; Algorithm</h2>
    <div style="font-family:monospace;font-size:12px;color:var(--text);background:var(--bg);padding:16px;border-radius:8px;border:1px solid var(--border);line-height:1.8;overflow-x:auto">
      <span style="color:var(--purple)">FUNCTION</span> hierarchicalLookup(query, speakerFilter):<br>
      <br>
      &nbsp;&nbsp;<span style="color:var(--muted)">// Step 1: Speaker split (halves search space)</span><br>
      &nbsp;&nbsp;<span style="color:var(--accent)">IF</span> speakerFilter: candidates = index.speaker[filter] <span style="color:var(--muted)">// O(1)</span><br>
      <br>
      &nbsp;&nbsp;<span style="color:var(--muted)">// Step 2: Keyword intersection (exponential narrowing)</span><br>
      &nbsp;&nbsp;<span style="color:var(--accent)">FOR EACH</span> keyword <span style="color:var(--accent)">IN</span> query:<br>
      &nbsp;&nbsp;&nbsp;&nbsp;hits = index.keywords[keyword] <span style="color:var(--muted)">// O(1) hash lookup</span><br>
      &nbsp;&nbsp;&nbsp;&nbsp;candidates = candidates <span style="color:var(--yellow)">&cap;</span> hits <span style="color:var(--muted)">// set intersection</span><br>
      <br>
      &nbsp;&nbsp;<span style="color:var(--muted)">// Step 3: Score + rank</span><br>
      &nbsp;&nbsp;<span style="color:var(--accent)">FOR EACH</span> id <span style="color:var(--accent)">IN</span> candidates:<br>
      &nbsp;&nbsp;&nbsp;&nbsp;score = keywordOverlap * 10 + recency + confidence<br>
      <br>
      &nbsp;&nbsp;<span style="color:var(--green)">RETURN</span> top-K results <span style="color:var(--muted)">// typically 3-10 entries</span>
    </div>
  </div>

</div>

<div class="footer">
  FPCS Memory Bank &bull; Hierarchical Knowledge System &bull; Page 4 of FPCS Dashboard &bull; Simulation: 4,000 trials
</div>

</div><!-- end dashContent -->

<script>
// === SIMULATION DATA (embedded from simulation_results.json) ===
var SIM_DATA = {
  "10":{"flat_ops":38,"hier_ops":3,"speedup":14,"narrowing":3.5,"cache_hit":0.003,"flat_time":0.005,"hier_time":0.002},
  "100":{"flat_ops":327,"hier_ops":10,"speedup":37,"narrowing":53,"cache_hit":0.004,"flat_time":0.042,"hier_time":0.007},
  "1000":{"flat_ops":3274,"hier_ops":81,"speedup":41,"narrowing":391,"cache_hit":0.041,"flat_time":0.494,"hier_time":0.053},
  "10000":{"flat_ops":33284,"hier_ops":814,"speedup":41,"narrowing":2193,"cache_hit":0.192,"flat_time":5.498,"hier_time":0.796}
};
var SCALES = [10, 100, 1000, 10000];

// === SIMULATED INDEX for Live Demo ===
var DEMO_KEYWORDS = {
  'ebay':[482,37],'paypal':[465,39],'amazon':[471,35],'deduction':[473,41],'income':[467,38],
  'expense':[459,33],'schedule-c':[451,29],'mileage':[448,31],'home-office':[456,28],
  'forensicbot':[462,22],'shield':[443,19],'ddbot':[439,17],'costco':[441,24],
  'insurance':[454,30],'contractor':[447,26],'sales':[469,36],'refund':[438,21],
  'transfer':[445,23],'categorized':[452,25],'qbo':[461,32],'ledger':[458,34],
  'bank':[464,40],'credit-card':[449,27],'receipt':[463,35],'turbotax':[436,18],
  'advertising':[441,22],'utilities':[437,20],'rent':[444,25],'repairs':[440,23],
  'travel':[455,30],'meals':[442,24],'phone':[446,26],'internet':[443,21],
  'software':[450,28],'equipment':[453,29],'storage':[435,16]
};

function runNarrowingDemo() {
  var query = document.getElementById('demoQuery').value.trim().toLowerCase();
  var speaker = document.getElementById('demoSpeaker').value;
  if (!query) return;
  var keywords = query.split(/\s+/).filter(function(k){return k.length>0});
  var total = 10000;
  var steps = [{label:'Total entries in memory bank', count:total, color:'var(--purple)'}];
  var current = total;
  if (speaker) {
    current = Math.round(total * (speaker==='ai'? 0.502 : 0.498));
    steps.push({label:'Speaker filter: '+speaker, count:current, color:'var(--accent)'});
  }
  for (var i=0;i<keywords.length;i++) {
    var kw = keywords[i];
    var kwData = DEMO_KEYWORDS[kw];
    if (kwData) {
      var hits = kwData[0];
      current = Math.max(1, Math.round(current * hits / total * (0.6+Math.random()*0.4)));
    } else {
      current = Math.max(0, Math.round(current * 0.03));
    }
    steps.push({label:'Keyword "'+kw+'"', count:current, color:['var(--green)','var(--yellow)','var(--orange)','var(--red)'][Math.min(i,3)]});
    if (current === 0) break;
  }
  steps.push({label:'Final results (scored + ranked)', count:Math.min(current, 10), color:'var(--green)'});
  var maxCount = steps[0].count;
  var html = '';
  for (var s=0;s<steps.length;s++) {
    var pct = Math.max(0.5, (steps[s].count / maxCount) * 100);
    html += '<div class="narrow-step">';
    html += '<div class="narrow-label">' + steps[s].label + '</div>';
    html += '<div class="narrow-bar-wrap"><div class="narrow-bar" style="width:'+pct+'%;background:'+steps[s].color+'"><span>'+steps[s].count.toLocaleString()+'</span></div></div>';
    html += '<div class="narrow-count">' + steps[s].count.toLocaleString() + '</div>';
    html += '</div>';
    if (s < steps.length-1) html += '<div class="connector"></div>';
  }
  var ratio = Math.round(steps[0].count / Math.max(1, steps[steps.length-1].count));
  html += '<div style="margin-top:16px;padding:12px;background:rgba(74,222,128,0.08);border:1px solid rgba(74,222,128,0.3);border-radius:8px;font-size:14px">';
  html += '<strong style="color:var(--green)">'+ratio.toLocaleString()+'x narrowing</strong>';
  html += ' &mdash; Searched '+steps[0].count.toLocaleString()+' entries, returned '+steps[steps.length-1].count+' results';
  html += '</div>';
  document.getElementById('narrowingViz').innerHTML = html;
  // Animate bars
  setTimeout(function(){
    var bars = document.querySelectorAll('.narrow-bar');
    bars.forEach(function(b){b.style.width=b.style.width});
  }, 50);
}

// === CANVAS CHARTS ===
function drawBarChart(canvasId, labels, datasets) {
  var canvas = document.getElementById(canvasId);
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 280 * dpr;
  ctx.scale(dpr, dpr);
  var W = rect.width, H = 280;
  var pad = {top:20,right:20,bottom:40,left:70};
  var chartW = W-pad.left-pad.right, chartH = H-pad.top-pad.bottom;
  ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,W,H);
  // Find max value
  var maxVal = 0;
  datasets.forEach(function(ds){ds.data.forEach(function(v){if(v>maxVal)maxVal=v})});
  maxVal = maxVal * 1.15;
  // Grid lines
  ctx.strokeStyle = '#334155'; ctx.lineWidth = 0.5;
  for (var i=0;i<=4;i++) {
    var y = pad.top + chartH - (i/4)*chartH;
    ctx.beginPath(); ctx.moveTo(pad.left,y); ctx.lineTo(W-pad.right,y); ctx.stroke();
    ctx.fillStyle = '#94a3b8'; ctx.font = '10px system-ui'; ctx.textAlign = 'right';
    ctx.fillText(Math.round(maxVal*i/4).toLocaleString(), pad.left-8, y+4);
  }
  // Bars
  var groupW = chartW / labels.length;
  var barW = groupW / (datasets.length + 1);
  datasets.forEach(function(ds, di) {
    ds.data.forEach(function(val, li) {
      var x = pad.left + li * groupW + (di + 0.5) * barW;
      var barH = (val / maxVal) * chartH;
      var y = pad.top + chartH - barH;
      ctx.fillStyle = ds.color;
      ctx.beginPath();
      var r = 3;
      ctx.moveTo(x, y + r); ctx.arcTo(x, y, x + barW - 4, y, r);
      ctx.arcTo(x + barW - 4, y, x + barW - 4, y + barH, r);
      ctx.lineTo(x + barW - 4, pad.top + chartH);
      ctx.lineTo(x, pad.top + chartH); ctx.closePath(); ctx.fill();
      // Value on top
      ctx.fillStyle = ds.color; ctx.font = 'bold 9px system-ui'; ctx.textAlign = 'center';
      ctx.fillText(val >= 1000 ? Math.round(val/1000)+'K' : val.toString(), x + (barW-4)/2, y - 4);
    });
  });
  // X labels
  ctx.fillStyle = '#94a3b8'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  labels.forEach(function(l, i) {
    ctx.fillText(l, pad.left + i * groupW + groupW/2, H - 12);
  });
  // Legend
  var lx = pad.left;
  datasets.forEach(function(ds) {
    ctx.fillStyle = ds.color; ctx.fillRect(lx, H - 28, 10, 10);
    ctx.fillStyle = '#e2e8f0'; ctx.font = '10px system-ui'; ctx.textAlign = 'left';
    ctx.fillText(ds.label, lx + 14, H - 19);
    lx += ctx.measureText(ds.label).width + 30;
  });
}

function drawLineChart(canvasId, labels, datasets) {
  var canvas = document.getElementById(canvasId);
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 280 * dpr;
  ctx.scale(dpr, dpr);
  var W = rect.width, H = 280;
  var pad = {top:20,right:20,bottom:40,left:70};
  var chartW = W-pad.left-pad.right, chartH = H-pad.top-pad.bottom;
  ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,W,H);
  var maxVal = 0;
  datasets.forEach(function(ds){ds.data.forEach(function(v){if(v>maxVal)maxVal=v})});
  maxVal = maxVal * 1.15;
  // Use log scale if range > 100x
  var useLog = maxVal / Math.max(1, Math.min.apply(null, datasets[0].data.filter(function(v){return v>0}))) > 50;
  function scaleY(v) {
    if (useLog && v > 0) return pad.top + chartH - (Math.log10(v) / Math.log10(maxVal)) * chartH;
    return pad.top + chartH - (v / maxVal) * chartH;
  }
  // Grid
  ctx.strokeStyle = '#334155'; ctx.lineWidth = 0.5;
  var gridSteps = useLog ? [1,10,100,1000,10000] : [0, maxVal*0.25, maxVal*0.5, maxVal*0.75, maxVal];
  gridSteps.forEach(function(v) {
    if (v > maxVal) return;
    var y = scaleY(v);
    ctx.beginPath(); ctx.moveTo(pad.left,y); ctx.lineTo(W-pad.right,y); ctx.stroke();
    ctx.fillStyle = '#94a3b8'; ctx.font = '10px system-ui'; ctx.textAlign = 'right';
    ctx.fillText(v >= 1000 ? Math.round(v/1000)+'K' : Math.round(v).toString(), pad.left-8, y+4);
  });
  // Lines
  datasets.forEach(function(ds) {
    ctx.beginPath(); ctx.strokeStyle = ds.color; ctx.lineWidth = 2.5;
    ds.data.forEach(function(v, i) {
      var x = pad.left + (i / (labels.length-1)) * chartW;
      var y = scaleY(v);
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
    // Dots
    ds.data.forEach(function(v, i) {
      var x = pad.left + (i / (labels.length-1)) * chartW;
      var y = scaleY(v);
      ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fillStyle = ds.color; ctx.fill();
      ctx.fillStyle = ds.color; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
      ctx.fillText(v >= 1000 ? Math.round(v/1000)+'K' : Math.round(v).toString(), x, y-10);
    });
  });
  // X labels
  ctx.fillStyle = '#94a3b8'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  labels.forEach(function(l, i) {
    ctx.fillText(l, pad.left + (i/(labels.length-1))*chartW, H-12);
  });
  // Legend
  var lx = pad.left;
  datasets.forEach(function(ds) {
    ctx.beginPath(); ctx.strokeStyle=ds.color; ctx.lineWidth=2;
    ctx.moveTo(lx,H-23); ctx.lineTo(lx+16,H-23); ctx.stroke();
    ctx.beginPath(); ctx.arc(lx+8,H-23,3,0,Math.PI*2); ctx.fillStyle=ds.color; ctx.fill();
    ctx.fillStyle='#e2e8f0'; ctx.font='10px system-ui'; ctx.textAlign='left';
    ctx.fillText(ds.label, lx+20, H-19);
    lx += ctx.measureText(ds.label).width + 40;
  });
  if (useLog) {
    ctx.fillStyle='#94a3b8'; ctx.font='9px system-ui'; ctx.textAlign='right';
    ctx.fillText('log scale', W-pad.right, pad.top+10);
  }
}

function drawWaterfallChart(canvasId) {
  var canvas = document.getElementById(canvasId);
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 280 * dpr;
  ctx.scale(dpr, dpr);
  var W = rect.width, H = 280;
  var pad = {top:20,right:20,bottom:50,left:20};
  ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,W,H);
  // Waterfall data (from 10K trace)
  var steps = [
    {label:'All Entries',count:10000,color:'#a78bfa'},
    {label:'Speaker: AI',count:5006,color:'#38bdf8'},
    {label:'"parking"',count:475,color:'#4ade80'},
    {label:'"home-office"',count:15,color:'#fbbf24'},
    {label:'"phone"',count:1,color:'#fb923c'},
    {label:'Results',count:1,color:'#4ade80'}
  ];
  var maxVal = steps[0].count;
  var barW = (W - pad.left - pad.right) / steps.length - 8;
  steps.forEach(function(step, i) {
    var x = pad.left + i * (barW + 8) + 4;
    var pct = Math.max(0.02, step.count / maxVal);
    var barH = pct * (H - pad.top - pad.bottom);
    var y = pad.top + (H - pad.top - pad.bottom) - barH;
    // Bar
    ctx.fillStyle = step.color;
    ctx.beginPath();
    var r = 3;
    ctx.moveTo(x, y+r); ctx.arcTo(x,y,x+barW,y,r); ctx.arcTo(x+barW,y,x+barW,y+barH,r);
    ctx.lineTo(x+barW, pad.top+(H-pad.top-pad.bottom)); ctx.lineTo(x, pad.top+(H-pad.top-pad.bottom));
    ctx.closePath(); ctx.fill();
    // Value
    ctx.fillStyle = step.color; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(step.count.toLocaleString(), x+barW/2, y-6);
    // Label
    ctx.fillStyle = '#94a3b8'; ctx.font = '9px system-ui';
    ctx.fillText(step.label, x+barW/2, H-20);
    // Arrow
    if (i < steps.length-1) {
      var nx = pad.left + (i+1)*(barW+8)+4;
      ctx.strokeStyle = '#475569'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(x+barW+2, H/2); ctx.lineTo(nx-2, H/2); ctx.stroke();
      // Reduction label
      if (steps[i+1].count < step.count) {
        var reduction = Math.round((1 - steps[i+1].count/step.count)*100);
        ctx.fillStyle = '#f87171'; ctx.font = 'bold 8px system-ui';
        ctx.fillText('-'+reduction+'%', (x+barW+nx)/2, H/2-6);
      }
    }
  });
  ctx.fillStyle='#4ade80'; ctx.font='bold 11px system-ui'; ctx.textAlign='center';
  ctx.fillText('10,000x narrowing', W/2, H-4);
}

// === RENDER ALL CHARTS ===
function renderCharts() {
  var labels = ['10','100','1K','10K'];
  drawBarChart('chartOps', labels, [
    {label:'Flat Scan', data:SCALES.map(function(s){return SIM_DATA[s].flat_ops}), color:'#f87171'},
    {label:'Hierarchical', data:SCALES.map(function(s){return SIM_DATA[s].hier_ops}), color:'#4ade80'}
  ]);
  drawLineChart('chartSpeedup', labels, [
    {label:'Speedup (ops)', data:SCALES.map(function(s){return SIM_DATA[s].speedup}), color:'#fbbf24'},
    {label:'Narrowing Ratio', data:SCALES.map(function(s){return SIM_DATA[s].narrowing}), color:'#a78bfa'}
  ]);
  drawLineChart('chartTime', labels, [
    {label:'Flat Time (ms)', data:SCALES.map(function(s){return SIM_DATA[s].flat_time}), color:'#f87171'},
    {label:'Hier Time (ms)', data:SCALES.map(function(s){return SIM_DATA[s].hier_time}), color:'#4ade80'}
  ]);
  drawWaterfallChart('chartNarrow');
}

// Run demo on load
window.addEventListener('load', function() {
  setTimeout(renderCharts, 100);
  setTimeout(runNarrowingDemo, 200);
});
window.addEventListener('resize', function() { setTimeout(renderCharts, 100); });
</script>
<script>
  window.FPCS_PAGE = {
    name: 'Memory Bank',
    theme: 'theme-memory'
  };
  window.FPCS_NAV = {
    active: 'memory',
    sections: [
      { id: 'top', icon: '&#128218;', label: 'Memory Bank' },
      { id: 'sec-arch', icon: '&#127959;', label: 'Architecture' },
      { id: 'sec-sim', icon: '&#128200;', label: 'Simulation' },
      { id: 'sec-demo', icon: '&#9889;', label: 'Live Demo' }
    ]
  };
</script>
<script src="js/auth.js"></script>
<script src="js/nav.js"></script>
<script src="bot-assistant.js"></script>
</body>
</html>
