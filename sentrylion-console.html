<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SentryLion // Fleet Console</title>
<style>
/* ═══════════════════════════════════════════════════════════
   SENTRYLION FLEET CONSOLE — Multi-Agent Command Center
   Deep Space / Cyberpunk Fleet Operations
   ═══════════════════════════════════════════════════════════ */

@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-deep: #0a0e1a;
  --bg-panel: #0d1225;
  --bg-card: #111831;
  --bg-card-hover: #151d3a;
  --border: #1a2340;
  --border-glow: #1e2d55;
  --amber: #f59e0b;
  --amber-dark: #d97706;
  --amber-glow: rgba(245,158,11,0.3);
  --cyan: #38bdf8;
  --cyan-dark: #0ea5e9;
  --cyan-glow: rgba(56,189,248,0.3);
  --green: #22c55e;
  --green-glow: rgba(34,197,94,0.3);
  --red: #ef4444;
  --red-glow: rgba(239,68,68,0.4);
  --yellow: #eab308;
  --orange: #f97316;
  --purple: #a855f7;
  --text-primary: #e2e8f0;
  --text-dim: #64748b;
  --text-bright: #f8fafc;
  --grid-line: rgba(56,189,248,0.06);
}

html, body {
  width: 100%; height: 100%; overflow: hidden;
  background: var(--bg-deep);
  color: var(--text-primary);
  font-family: 'Share Tech Mono', monospace;
}

/* ── SCAN LINES ── */
body::before {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 9999;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(56,189,248,0.015) 2px, rgba(56,189,248,0.015) 4px);
}

/* ── GRID BG ── */
body::after {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: -1;
  background-image: linear-gradient(var(--grid-line) 1px, transparent 1px),
                    linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
  background-size: 40px 40px;
}

/* ── LAYOUT ── */
#dashContent { display: flex; height: 100vh; overflow: hidden; }
.main-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

/* ── TOP BAR ── */
.top-bar {
  display: flex; align-items: center; gap: 16px; padding: 10px 20px;
  background: var(--bg-panel); border-bottom: 1px solid var(--border);
  min-height: 52px; flex-shrink: 0;
}
.top-bar .logo {
  display: flex; align-items: center; gap: 10px;
  font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 15px;
  color: var(--red); text-transform: uppercase; letter-spacing: 2px;
  text-shadow: 0 0 20px rgba(239,68,68,0.4);
}
.top-bar .logo span { color: var(--amber); }
.lion-icon {
  width: 36px; height: 36px; flex-shrink: 0;
  filter: drop-shadow(0 0 6px rgba(239,68,68,0.5)) drop-shadow(0 0 14px rgba(245,158,11,0.3));
  animation: lionPulse 3s ease-in-out infinite;
}
@keyframes lionPulse {
  0%, 100% { filter: drop-shadow(0 0 6px rgba(239,68,68,0.5)) drop-shadow(0 0 14px rgba(245,158,11,0.3)); }
  50% { filter: drop-shadow(0 0 10px rgba(239,68,68,0.8)) drop-shadow(0 0 22px rgba(245,158,11,0.5)); }
}
.fleet-stats {
  display: flex; gap: 20px; margin-left: auto; font-size: 11px; color: var(--text-dim);
}
.fleet-stat { display: flex; align-items: center; gap: 6px; }
.fleet-stat .val { color: var(--text-bright); font-size: 14px; font-weight: 700; }
.fleet-stat.critical .val { color: var(--red); text-shadow: 0 0 8px var(--red-glow); }

.top-btn {
  padding: 6px 14px; font-family: 'Share Tech Mono'; font-size: 11px;
  background: transparent; color: var(--text-dim); border: 1px solid var(--border);
  cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
  transition: all 0.2s;
}
.top-btn:hover { border-color: var(--amber); color: var(--amber); background: rgba(245,158,11,0.08); }
.top-btn.active { border-color: var(--cyan); color: var(--cyan); background: rgba(56,189,248,0.08); }
.top-btn.danger { border-color: var(--red); color: var(--red); }
.top-btn.danger:hover { background: rgba(239,68,68,0.15); }

/* ── FLEET GRID ── */
.fleet-view { flex: 1; overflow-y: auto; padding: 20px; }
.fleet-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 16px;
}

/* ── AGENT CARD ── */
.agent-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 8px; padding: 16px; cursor: pointer;
  transition: all 0.25s; position: relative; overflow: hidden;
}
.agent-card:hover {
  border-color: var(--cyan-dark); background: var(--bg-card-hover);
  transform: translateY(-2px); box-shadow: 0 4px 20px rgba(56,189,248,0.1);
}
.agent-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
}
.agent-card.status-online::before { background: var(--green); box-shadow: 0 0 12px var(--green-glow); }
.agent-card.status-offline::before { background: var(--text-dim); }
.agent-card.status-jailed::before { background: var(--red); box-shadow: 0 0 12px var(--red-glow); }
.agent-card.status-probation::before { background: var(--orange); animation: probPulse 1.5s ease-in-out infinite; }
.agent-card.status-cleaning::before { background: var(--purple); animation: probPulse 1s ease-in-out infinite; }
.agent-card.status-cleaned::before { background: var(--green); }

@keyframes probPulse { 0%,100%{opacity:0.5} 50%{opacity:1} }

.card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
.card-hostname {
  font-family: 'Orbitron'; font-size: 13px; font-weight: 700;
  color: var(--text-bright); letter-spacing: 1px;
}
.card-ip { font-size: 11px; color: var(--text-dim); margin-left: auto; }

.status-badge {
  padding: 2px 8px; border-radius: 3px; font-size: 9px;
  text-transform: uppercase; letter-spacing: 1px; font-weight: 700;
}
.badge-online { background: rgba(34,197,94,0.15); color: var(--green); border: 1px solid rgba(34,197,94,0.3); }
.badge-offline { background: rgba(100,116,139,0.15); color: var(--text-dim); border: 1px solid rgba(100,116,139,0.3); }
.badge-jailed { background: rgba(239,68,68,0.15); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }
.badge-probation { background: rgba(249,115,22,0.15); color: var(--orange); border: 1px solid rgba(249,115,22,0.3); }
.badge-cleaning { background: rgba(168,85,247,0.15); color: var(--purple); border: 1px solid rgba(168,85,247,0.3); }
.badge-cleaned { background: rgba(34,197,94,0.15); color: var(--green); border: 1px solid rgba(34,197,94,0.3); }
.badge-critical { background: rgba(239,68,68,0.2); color: #ff6b6b; border: 1px solid rgba(239,68,68,0.4); animation: probPulse 1s infinite; }

.card-body { display: flex; flex-direction: column; gap: 8px; }

.card-row { display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-dim); }
.card-row .label { min-width: 32px; }
.card-row .bar-bg {
  flex: 1; height: 6px; background: rgba(255,255,255,0.05);
  border-radius: 3px; overflow: hidden;
}
.card-row .bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
.bar-cpu { background: linear-gradient(90deg, var(--cyan), var(--cyan-dark)); }
.bar-mem { background: linear-gradient(90deg, var(--amber), var(--amber-dark)); }
.bar-cpu.high { background: linear-gradient(90deg, var(--orange), var(--red)); }
.bar-mem.high { background: linear-gradient(90deg, var(--orange), var(--red)); }
.card-row .val { min-width: 32px; text-align: right; color: var(--text-primary); }

.card-meta { display: flex; gap: 12px; font-size: 10px; color: var(--text-dim); margin-top: 4px; flex-wrap: wrap; }
.card-meta .meta-item { display: flex; align-items: center; gap: 4px; }

.threat-indicator {
  display: inline-block; padding: 2px 6px; border-radius: 2px;
  font-size: 9px; font-weight: 700; letter-spacing: 1px;
}
.threat-LOW { background: rgba(34,197,94,0.12); color: var(--green); }
.threat-MODERATE { background: rgba(234,179,8,0.12); color: var(--yellow); }
.threat-HIGH { background: rgba(249,115,22,0.12); color: var(--orange); }
.threat-CRITICAL { background: rgba(239,68,68,0.15); color: var(--red); animation: probPulse 0.8s infinite; }
.threat-UNKNOWN { background: rgba(100,116,139,0.1); color: var(--text-dim); }

.hardening-score {
  display: inline-block; padding: 2px 6px; border-radius: 2px;
  font-size: 9px; font-weight: 700;
}
.hs-good { background: rgba(34,197,94,0.12); color: var(--green); }
.hs-warn { background: rgba(234,179,8,0.12); color: var(--yellow); }
.hs-bad { background: rgba(239,68,68,0.12); color: var(--red); }

.card-heartbeat { font-size: 10px; color: var(--text-dim); text-align: right; margin-top: 4px; }

/* ── PROBATION BAR ── */
.probation-bar {
  height: 4px; background: rgba(255,255,255,0.05); border-radius: 2px;
  margin-top: 8px; overflow: hidden;
}
.probation-fill {
  height: 100%; border-radius: 2px; transition: width 1s linear;
}
.prob-stage-1 { background: #c2410c; width: 16.67%; }
.prob-stage-2 { background: #ea580c; width: 33.33%; }
.prob-stage-3 { background: #f97316; width: 50%; }
.prob-stage-4 { background: #fb923c; width: 66.67%; }
.prob-stage-5 { background: #fbbf24; width: 83.33%; }
.prob-stage-6 { background: #a3e635; width: 100%; }

/* ── AGENT DETAIL VIEW ── */
.detail-view {
  display: none; flex: 1; flex-direction: column; overflow: hidden;
}
.detail-view.active { display: flex; }
.fleet-view.hidden { display: none; }

.detail-header {
  display: flex; align-items: center; gap: 16px; padding: 12px 20px;
  background: var(--bg-panel); border-bottom: 1px solid var(--border);
}
.back-btn {
  padding: 6px 12px; font-family: 'Share Tech Mono'; font-size: 12px;
  background: transparent; color: var(--cyan); border: 1px solid var(--border);
  cursor: pointer; transition: all 0.2s;
}
.back-btn:hover { border-color: var(--cyan); background: rgba(56,189,248,0.08); }
.detail-title {
  font-family: 'Orbitron'; font-size: 15px; font-weight: 700; color: var(--text-bright);
}
.detail-subtitle { font-size: 11px; color: var(--text-dim); margin-left: 8px; }

.detail-body { flex: 1; display: flex; overflow: hidden; }

/* Left panel — system info + threat gauge */
.detail-left {
  width: 320px; flex-shrink: 0; overflow-y: auto; padding: 16px;
  border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 16px;
}

.info-block {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 6px; padding: 12px;
}
.info-block h3 {
  font-family: 'Orbitron'; font-size: 10px; color: var(--amber);
  text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px;
}
.info-row {
  display: flex; justify-content: space-between; padding: 4px 0;
  font-size: 11px; border-bottom: 1px solid rgba(255,255,255,0.03);
}
.info-row:last-child { border-bottom: none; }
.info-row .lbl { color: var(--text-dim); }
.info-row .val { color: var(--text-primary); }

/* Threat gauge in detail */
.threat-gauge-wrap { text-align: center; padding: 12px 0; }
.threat-gauge-val {
  font-family: 'Orbitron'; font-size: 36px; font-weight: 900;
}
.threat-gauge-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; }

/* Detail center — logs */
.detail-center { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.log-header {
  display: flex; align-items: center; gap: 8px; padding: 8px 12px;
  background: var(--bg-card); border-bottom: 1px solid var(--border);
  font-size: 11px;
}
.log-stream {
  flex: 1; overflow-y: auto; padding: 8px; font-size: 11px;
  background: rgba(0,0,0,0.2);
}
.log-entry { padding: 3px 6px; border-bottom: 1px solid rgba(255,255,255,0.02); line-height: 1.4; }
.log-entry .tag { font-weight: 700; margin-right: 6px; }
.tag-SHIELD { color: var(--cyan); }
.tag-THREAT { color: var(--red); }
.tag-JAIL { color: var(--orange); }
.tag-SCAN { color: var(--green); }
.tag-YARA { color: #ff6b6b; }
.tag-SIGMA { color: var(--purple); }
.tag-ML { color: var(--cyan); }
.tag-HARDEN { color: var(--amber); }
.tag-VT { color: #c084fc; }
.tag-CANARY { color: #fb923c; }
.tag-COMMAND { color: var(--yellow); }
.log-time { color: var(--text-dim); margin-right: 6px; }

/* ── COMMAND PANEL (slide-out) ── */
.cmd-panel {
  position: fixed; top: 0; right: -440px; width: 440px; height: 100vh;
  background: var(--bg-panel); border-left: 1px solid var(--border);
  z-index: 1000; transition: right 0.3s ease; display: flex; flex-direction: column;
  box-shadow: -4px 0 30px rgba(0,0,0,0.5);
}
.cmd-panel.open { right: 0; }
.cmd-panel-header {
  display: flex; align-items: center; padding: 12px 16px;
  border-bottom: 1px solid var(--border); gap: 12px;
}
.cmd-panel-header h2 {
  font-family: 'Orbitron'; font-size: 12px; color: var(--amber);
  text-transform: uppercase; letter-spacing: 2px;
}
.cmd-close {
  margin-left: auto; background: none; border: none; color: var(--text-dim);
  font-size: 18px; cursor: pointer; padding: 4px 8px;
}
.cmd-close:hover { color: var(--red); }

.cmd-body { flex: 1; overflow-y: auto; padding: 12px; }
.cmd-section { margin-bottom: 16px; }
.cmd-section h4 {
  font-size: 10px; color: var(--text-dim); text-transform: uppercase;
  letter-spacing: 1.5px; margin-bottom: 8px; padding-bottom: 4px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.cmd-btn {
  display: flex; align-items: center; gap: 10px; width: 100%;
  padding: 10px 14px; margin-bottom: 6px; font-family: 'Share Tech Mono';
  font-size: 11px; background: var(--bg-card); color: var(--text-primary);
  border: 1px solid var(--border); cursor: pointer; text-align: left;
  transition: all 0.15s; border-radius: 4px;
}
.cmd-btn:hover { border-color: var(--cyan); color: var(--cyan); background: rgba(56,189,248,0.05); }
.cmd-btn.danger:hover { border-color: var(--red); color: var(--red); background: rgba(239,68,68,0.05); }
.cmd-btn .cmd-icon { font-size: 16px; width: 24px; text-align: center; }
.cmd-btn .cmd-label { flex: 1; }
.cmd-btn .cmd-desc { font-size: 9px; color: var(--text-dim); }

.cmd-input-group { margin-bottom: 10px; }
.cmd-input-group label { display: block; font-size: 10px; color: var(--text-dim); margin-bottom: 4px; }
.cmd-input {
  width: 100%; padding: 8px 10px; font-family: 'Share Tech Mono'; font-size: 12px;
  background: var(--bg-deep); color: var(--text-primary); border: 1px solid var(--border);
  outline: none;
}
.cmd-input:focus { border-color: var(--cyan); }

/* Command history */
.cmd-history { margin-top: 12px; }
.cmd-history-item {
  display: flex; align-items: center; gap: 8px; padding: 6px 8px;
  font-size: 10px; border-bottom: 1px solid rgba(255,255,255,0.03);
}
.cmd-status-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.cmd-status-pending { background: var(--yellow); }
.cmd-status-executing { background: var(--cyan); animation: probPulse 0.8s infinite; }
.cmd-status-running { background: var(--cyan); animation: probPulse 0.8s infinite; }
.cmd-status-completed { background: var(--green); }
.cmd-status-failed { background: var(--red); }
.cmd-history-item { cursor: pointer; }
.cmd-history-item:hover { background: rgba(56,189,248,0.05); }
.cmd-output-box {
  display: none; margin: 4px 0 8px; padding: 8px; background: #0a0e1a;
  border: 1px solid var(--border); border-radius: 4px;
  font-size: 9px; line-height: 1.4; color: var(--text-dim);
  white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow-y: auto;
}
.cmd-output-box.open { display: block; }

/* ── CONFIRM MODAL ── */
.confirm-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  z-index: 2000; align-items: center; justify-content: center;
}
.confirm-overlay.active { display: flex; }
.confirm-box {
  background: var(--bg-panel); border: 1px solid var(--border);
  border-radius: 8px; padding: 24px; max-width: 420px; width: 90%;
  text-align: center;
}
.confirm-box h3 {
  font-family: 'Orbitron'; font-size: 14px; color: var(--amber);
  margin-bottom: 12px;
}
.confirm-box p { font-size: 12px; color: var(--text-dim); margin-bottom: 20px; line-height: 1.5; }
.confirm-actions { display: flex; gap: 12px; justify-content: center; }
.confirm-yes, .confirm-no {
  padding: 8px 24px; font-family: 'Share Tech Mono'; font-size: 12px;
  cursor: pointer; border-radius: 4px; border: 1px solid;
}
.confirm-yes { background: rgba(239,68,68,0.15); color: var(--red); border-color: var(--red); }
.confirm-yes:hover { background: rgba(239,68,68,0.3); }
.confirm-no { background: transparent; color: var(--text-dim); border-color: var(--border); }
.confirm-no:hover { color: var(--text-primary); border-color: var(--text-dim); }

/* ── EMPTY STATE ── */
.empty-state {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  height: 100%; color: var(--text-dim); text-align: center; gap: 16px;
}
.empty-icon { font-size: 64px; opacity: 0.3; }
.empty-title { font-family: 'Orbitron'; font-size: 16px; color: var(--text-primary); }
.empty-text { font-size: 12px; max-width: 400px; line-height: 1.6; }

/* ── SCROLLBAR ── */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
</style>
</head>
<body>
<!-- ═══════════════════ AUTH + NAV ═══════════════════ -->
<noscript><div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#0a0e1a;color:#f87171;font-family:sans-serif;text-align:center;padding:40px"><div><h1>&#128274; JavaScript Required</h1><p>Enable JavaScript to access the Fleet Console.</p></div></div></noscript>
<div id="authGate" style="display:none"></div>
<div id="dashContent" style="display:none">
<!-- Nav rail injected by nav.js -->

<div class="main-area">
<!-- ── TOP BAR ── -->
<div class="top-bar">
  <div class="logo">
    <svg class="lion-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- Mane outer -->
      <path d="M32 4C18 4 8 14 8 28c0 6 2 11 5 15l3 4c2 2 4 5 4 9v2h24v-2c0-4 2-7 4-9l3-4c3-4 5-9 5-15C56 14 46 4 32 4z" fill="url(#maneGrad)" opacity="0.85"/>
      <!-- Mane detail — spikes -->
      <path d="M14 18l-4-6 6 3M50 18l4-6-6 3M10 28l-6-2 5 4M54 28l6-2-5 4M18 10l-2-6 4 5M46 10l2-6-4 5M26 6l-1-4 3 3M38 6l1-4-3 3" stroke="#f59e0b" stroke-width="1.5" stroke-linecap="round" opacity="0.7"/>
      <!-- Face -->
      <ellipse cx="32" cy="32" rx="16" ry="18" fill="url(#faceGrad)"/>
      <!-- Eyes -->
      <ellipse cx="25" cy="28" rx="3" ry="3.5" fill="#0a0e1a"/>
      <ellipse cx="39" cy="28" rx="3" ry="3.5" fill="#0a0e1a"/>
      <!-- Eye glow -->
      <ellipse cx="25.5" cy="27.5" rx="1.2" ry="1.4" fill="#ef4444"/>
      <ellipse cx="39.5" cy="27.5" rx="1.2" ry="1.4" fill="#ef4444"/>
      <!-- Eye highlight -->
      <circle cx="24" cy="26.5" r="0.6" fill="#fff" opacity="0.8"/>
      <circle cx="38" cy="26.5" r="0.6" fill="#fff" opacity="0.8"/>
      <!-- Nose -->
      <path d="M30 34l2 2.5 2-2.5z" fill="#d97706"/>
      <!-- Mouth -->
      <path d="M28 38c2 2 6 2 8 0" stroke="#d97706" stroke-width="1.2" stroke-linecap="round" fill="none"/>
      <!-- Whiskers -->
      <line x1="18" y1="33" x2="10" y2="31" stroke="#f59e0b" stroke-width="0.8" opacity="0.5"/>
      <line x1="18" y1="35" x2="9" y2="36" stroke="#f59e0b" stroke-width="0.8" opacity="0.5"/>
      <line x1="46" y1="33" x2="54" y2="31" stroke="#f59e0b" stroke-width="0.8" opacity="0.5"/>
      <line x1="46" y1="35" x2="55" y2="36" stroke="#f59e0b" stroke-width="0.8" opacity="0.5"/>
      <!-- Ears -->
      <path d="M16 16l-2-8 8 6z" fill="#d97706" opacity="0.8"/>
      <path d="M48 16l2-8-8 6z" fill="#d97706" opacity="0.8"/>
      <path d="M17 15l-1-5 5 4z" fill="#ef4444" opacity="0.5"/>
      <path d="M47 15l1-5-5 4z" fill="#ef4444" opacity="0.5"/>
      <defs>
        <linearGradient id="maneGrad" x1="32" y1="0" x2="32" y2="58" gradientUnits="userSpaceOnUse">
          <stop offset="0" stop-color="#f59e0b"/>
          <stop offset="0.5" stop-color="#d97706"/>
          <stop offset="1" stop-color="#92400e"/>
        </linearGradient>
        <linearGradient id="faceGrad" x1="32" y1="14" x2="32" y2="50" gradientUnits="userSpaceOnUse">
          <stop offset="0" stop-color="#fbbf24"/>
          <stop offset="1" stop-color="#d97706"/>
        </linearGradient>
      </defs>
    </svg>
    SentryLion <span>Fleet Console</span>
  </div>
  <div class="fleet-stats">
    <div class="fleet-stat"><span>AGENTS</span> <span class="val" id="statAgents">0</span></div>
    <div class="fleet-stat"><span>ONLINE</span> <span class="val" id="statOnline">0</span></div>
    <div class="fleet-stat critical"><span>THREATS</span> <span class="val" id="statThreats">0</span></div>
    <div class="fleet-stat"><span>JAILED</span> <span class="val" id="statJailed">0</span></div>
  </div>
  <button class="top-btn" id="btnDeploy" title="Deploy SentryLion to USB">&#128190; DEPLOY</button>
  <button class="top-btn" id="btnSeedDemo" title="Seed demo agents for testing">&#127922; DEMO</button>
</div>

<!-- ── FLEET OVERVIEW ── -->
<div class="fleet-view" id="fleetView">
  <div class="fleet-grid" id="fleetGrid">
    <div class="empty-state" id="emptyState">
      <svg class="lion-icon" style="width:80px;height:80px;opacity:0.4" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M32 4C18 4 8 14 8 28c0 6 2 11 5 15l3 4c2 2 4 5 4 9v2h24v-2c0-4 2-7 4-9l3-4c3-4 5-9 5-15C56 14 46 4 32 4z" fill="url(#maneGrad2)" opacity="0.85"/>
        <path d="M14 18l-4-6 6 3M50 18l4-6-6 3M10 28l-6-2 5 4M54 28l6-2-5 4M18 10l-2-6 4 5M46 10l2-6-4 5" stroke="#f59e0b" stroke-width="1.5" stroke-linecap="round" opacity="0.7"/>
        <ellipse cx="32" cy="32" rx="16" ry="18" fill="url(#faceGrad2)"/>
        <ellipse cx="25" cy="28" rx="3" ry="3.5" fill="#0a0e1a"/>
        <ellipse cx="39" cy="28" rx="3" ry="3.5" fill="#0a0e1a"/>
        <ellipse cx="25.5" cy="27.5" rx="1.2" ry="1.4" fill="#ef4444"/>
        <ellipse cx="39.5" cy="27.5" rx="1.2" ry="1.4" fill="#ef4444"/>
        <path d="M30 34l2 2.5 2-2.5z" fill="#d97706"/>
        <path d="M28 38c2 2 6 2 8 0" stroke="#d97706" stroke-width="1.2" stroke-linecap="round" fill="none"/>
        <path d="M16 16l-2-8 8 6z" fill="#d97706" opacity="0.8"/>
        <path d="M48 16l2-8-8 6z" fill="#d97706" opacity="0.8"/>
        <defs>
          <linearGradient id="maneGrad2" x1="32" y1="0" x2="32" y2="58" gradientUnits="userSpaceOnUse">
            <stop offset="0" stop-color="#f59e0b"/><stop offset="1" stop-color="#92400e"/>
          </linearGradient>
          <linearGradient id="faceGrad2" x1="32" y1="14" x2="32" y2="50" gradientUnits="userSpaceOnUse">
            <stop offset="0" stop-color="#fbbf24"/><stop offset="1" stop-color="#d97706"/>
          </linearGradient>
        </defs>
      </svg>
      <div class="empty-title">No Agents Detected</div>
      <div class="empty-text">
        Deploy SentryLion agents to your network to begin monitoring.
        Click <strong>DEMO</strong> above to seed test agents, or
        <strong>DEPLOY</strong> to create a portable agent package.
      </div>
    </div>
  </div>
</div>

<!-- ── AGENT DETAIL VIEW ── -->
<div class="detail-view" id="detailView">
  <div class="detail-header">
    <button class="back-btn" id="btnBack">&#8592; FLEET</button>
    <div class="detail-title" id="detailHostname">---</div>
    <div class="detail-subtitle" id="detailIP">---</div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="top-btn" id="btnCommands">&#9881; COMMANDS</button>
      <button class="top-btn" id="btnDetailLogs">&#128220; LOGS</button>
      <button class="top-btn" id="btnDetailJail">&#128274; IP JAIL</button>
    </div>
  </div>
  <div class="detail-body">
    <!-- Left panel: system info -->
    <div class="detail-left">
      <div class="info-block">
        <h3>System Info</h3>
        <div class="info-row"><span class="lbl">OS</span><span class="val" id="dOS">---</span></div>
        <div class="info-row"><span class="lbl">Status</span><span class="val" id="dStatus">---</span></div>
        <div class="info-row"><span class="lbl">Agent</span><span class="val" id="dVersion">---</span></div>
        <div class="info-row"><span class="lbl">Heartbeat</span><span class="val" id="dHeartbeat">---</span></div>
        <div class="info-row"><span class="lbl">Uptime</span><span class="val" id="dUptime">---</span></div>
        <div class="info-row"><span class="lbl">Processes</span><span class="val" id="dProcesses">---</span></div>
        <div class="info-row"><span class="lbl">Tools</span><span class="val" id="dTools">---</span></div>
        <div class="info-row"><span class="lbl">AI Status</span><span class="val" id="dAI">---</span></div>
      </div>
      <div class="info-block">
        <h3>Threat Level</h3>
        <div class="threat-gauge-wrap">
          <div class="threat-gauge-val" id="dThreatVal">LOW</div>
          <div class="threat-gauge-label">Current Threat Assessment</div>
        </div>
      </div>
      <div class="info-block">
        <h3>Resources</h3>
        <div class="card-row"><span class="label">CPU</span><div class="bar-bg"><div class="bar-fill bar-cpu" id="dCPUBar" style="width:0%"></div></div><span class="val" id="dCPUVal">0%</span></div>
        <div class="card-row"><span class="label">MEM</span><div class="bar-bg"><div class="bar-fill bar-mem" id="dMEMBar" style="width:0%"></div></div><span class="val" id="dMEMVal">0%</span></div>
        <div class="info-row" style="margin-top:6px"><span class="lbl">RAM</span><span class="val" id="dMemDetail" style="font-size:11px;color:var(--text-dim)">---</span></div>
      </div>
      <div class="info-block">
        <h3>Hardening</h3>
        <div class="info-row"><span class="lbl">Score</span><span class="val" id="dHardenScore">---</span></div>
        <div class="info-row"><span class="lbl">Last Audit</span><span class="val" id="dHardenDate">---</span></div>
      </div>
      <div class="info-block">
        <h3>Last Command</h3>
        <div class="info-row"><span class="lbl">Command</span><span class="val" id="dLastCmdName" style="color:var(--cyan)">---</span></div>
        <div class="info-row"><span class="lbl">Status</span><span class="val" id="dLastCmdStatus">---</span></div>
        <div class="info-row"><span class="lbl">Time</span><span class="val" id="dLastCmdTime">---</span></div>
        <div class="cmd-output-box open" id="dLastCmdOutput" style="max-height:150px;display:none"></div>
      </div>
    </div>
    <!-- Center: log stream -->
    <div class="detail-center">
      <div class="log-header">
        <span style="color:var(--amber)">&#9654;</span>
        <span>LIVE LOG STREAM</span>
        <span style="margin-left:auto;color:var(--text-dim)" id="logCount">0 entries</span>
      </div>
      <div class="log-stream" id="logStream">
        <div style="padding:20px;color:var(--text-dim);text-align:center">Connecting to agent log stream...</div>
      </div>
    </div>
  </div>
</div>

</div><!-- /main-area -->
</div><!-- /dashContent -->

<!-- ── COMMAND PANEL ── -->
<div class="cmd-panel" id="cmdPanel">
  <div class="cmd-panel-header">
    <h2>&#9881; Remote Commands</h2>
    <span id="cmdTarget" style="font-size:11px;color:var(--text-dim)">---</span>
    <button class="cmd-close" id="cmdClose">&times;</button>
  </div>
  <div class="cmd-body">
    <div class="cmd-section">
      <h4>System Control</h4>
      <button class="cmd-btn danger" onclick="confirmCommand('restart')">
        <span class="cmd-icon">&#128260;</span>
        <div><div class="cmd-label">Restart Computer</div><div class="cmd-desc">shutdown /r /t 30 — 30s warning</div></div>
      </button>
      <button class="cmd-btn danger" onclick="confirmCommand('shutdown')">
        <span class="cmd-icon">&#9211;</span>
        <div><div class="cmd-label">Shutdown Computer</div><div class="cmd-desc">shutdown /s /t 60 — 60s warning</div></div>
      </button>
      <button class="cmd-btn" onclick="confirmCommand('send_message')">
        <span class="cmd-icon">&#128172;</span>
        <div><div class="cmd-label">Send Message</div><div class="cmd-desc">Display message on remote screen</div></div>
      </button>
      <button class="cmd-btn" onclick="confirmCommand('ipconfig_renew')">
        <span class="cmd-icon">&#128268;</span>
        <div><div class="cmd-label">IP Release / Renew</div><div class="cmd-desc">ipconfig /release + /renew — brief drop</div></div>
      </button>
    </div>
    <div class="cmd-section">
      <h4>Diagnostics</h4>
      <button class="cmd-btn" onclick="confirmCommand('ipconfig')">
        <span class="cmd-icon">&#127760;</span>
        <div><div class="cmd-label">IP Config</div><div class="cmd-desc">ipconfig /all — show network adapters</div></div>
      </button>
      <button class="cmd-btn" onclick="confirmCommand('sysinfo')">
        <span class="cmd-icon">&#128187;</span>
        <div><div class="cmd-label">System Info</div><div class="cmd-desc">systeminfo — OS, hardware, uptime, hotfixes</div></div>
      </button>
      <button class="cmd-btn" onclick="confirmCommand('tasklist')">
        <span class="cmd-icon">&#128203;</span>
        <div><div class="cmd-label">Task List</div><div class="cmd-desc">tasklist — running processes (top 80)</div></div>
      </button>
      <button class="cmd-btn" onclick="confirmCommand('netstat')">
        <span class="cmd-icon">&#128279;</span>
        <div><div class="cmd-label">Netstat</div><div class="cmd-desc">netstat -an -p TCP — active connections</div></div>
      </button>
      <button class="cmd-btn" onclick="confirmCommand('whoami')">
        <span class="cmd-icon">&#128100;</span>
        <div><div class="cmd-label">Who Am I</div><div class="cmd-desc">whoami /all — user, groups, privileges</div></div>
      </button>
    </div>
    <div class="cmd-section">
      <h4>Security Scanning</h4>
      <button class="cmd-btn" onclick="confirmCommand('full-scan')">
        <span class="cmd-icon">&#128270;</span>
        <div><div class="cmd-label">Force Full Scan</div><div class="cmd-desc">YARA + Sigma + ML anomaly detection</div></div>
      </button>
      <button class="cmd-btn" onclick="confirmCommand('hardening_audit')">
        <span class="cmd-icon">&#128737;</span>
        <div><div class="cmd-label">Run Hardening Audit</div><div class="cmd-desc">GPO + Registry + HardeningKitty</div></div>
      </button>
      <button class="cmd-btn" onclick="confirmCommand('auto_harden')" style="border-color:var(--green)">
        <span class="cmd-icon">&#128272;</span>
        <div><div class="cmd-label">Auto-Harden System</div><div class="cmd-desc">Fix: SMBv1, WDigest, AutoRun, LLMNR, NetBIOS, PS logging</div></div>
      </button>
      <button class="cmd-btn" onclick="confirmCommand('temp_cleanup')">
        <span class="cmd-icon">&#128465;</span>
        <div><div class="cmd-label">Strategic Temp Cleanup</div><div class="cmd-desc">4-phase cleanup: persist → suspend → delete → verify</div></div>
      </button>
    </div>
    <div class="cmd-section">
      <h4>Malware Cleanup</h4>
      <button class="cmd-btn" onclick="confirmCommand('adwcleaner')">
        <span class="cmd-icon">&#129534;</span>
        <div><div class="cmd-label">Run AdwCleaner</div><div class="cmd-desc">Portable adware/PUP cleaner (~10MB)</div></div>
      </button>
      <button class="cmd-btn" onclick="confirmCommand('emsisoft')">
        <span class="cmd-icon">&#128737;</span>
        <div><div class="cmd-label">Run Emsisoft EEK</div><div class="cmd-desc">Full emergency malware scan (~250MB)</div></div>
      </button>
    </div>
    <div class="cmd-section">
      <h4>Emergency Response</h4>
      <button class="cmd-btn danger" onclick="confirmCommand('isolate')">
        <span class="cmd-icon">&#128721;</span>
        <div><div class="cmd-label">Isolate Machine</div><div class="cmd-desc">Block all network — allow Firebase heartbeat only</div></div>
      </button>
      <button class="cmd-btn" onclick="confirmCommand('unisolate')" style="border-color:var(--green)">
        <span class="cmd-icon">&#128275;</span>
        <div><div class="cmd-label">Remove Isolation</div><div class="cmd-desc">Restore full network access</div></div>
      </button>
      <button class="cmd-btn danger" onclick="confirmCommand('kill-connection')">
        <span class="cmd-icon">&#9986;</span>
        <div><div class="cmd-label">Kill Connection</div><div class="cmd-desc">Terminate specific remote IP session</div></div>
      </button>
      <button class="cmd-btn" onclick="confirmCommand('start-probation')">
        <span class="cmd-icon">&#9201;</span>
        <div><div class="cmd-label">Start Probation</div><div class="cmd-desc">3-min staged network restoration</div></div>
      </button>
    </div>
    <div class="cmd-section">
      <h4>Push File</h4>
      <div class="cmd-input-group">
        <label>File URL (agent will download + execute)</label>
        <input class="cmd-input" id="pushFileUrl" placeholder="https://example.com/tool.exe">
      </div>
      <button class="cmd-btn" onclick="confirmCommand('push-file')">
        <span class="cmd-icon">&#128228;</span>
        <div><div class="cmd-label">Push & Execute</div><div class="cmd-desc">Signed, verified remote file deployment</div></div>
      </button>
    </div>
    <div class="cmd-section">
      <h4>Recent Commands</h4>
      <div id="cmdHistory" class="cmd-history">
        <div style="font-size:10px;color:var(--text-dim);padding:8px">No commands sent yet</div>
      </div>
    </div>
  </div>
</div>

<!-- ── CONFIRM MODAL ── -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h3 id="confirmTitle">Confirm Action</h3>
    <p id="confirmMsg">Are you sure?</p>
    <div id="confirmInput" style="display:none;margin-bottom:16px">
      <input class="cmd-input" id="confirmInputField" placeholder="">
    </div>
    <div class="confirm-actions">
      <button class="confirm-no" onclick="closeConfirm()">Cancel</button>
      <button class="confirm-yes" id="confirmYes">Execute</button>
    </div>
  </div>
</div>

<!-- ═══════════════════ SCRIPTS ═══════════════════ -->
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

<!-- Page config -->
<script>
  window.FPCS_PAGE = { name: 'Fleet Console', theme: 'theme-fleet' };
  window.FPCS_NAV = {
    active: 'fleet',
    sections: [
      { icon: '&#128202;', label: 'Fleet Overview', href: '#fleet' },
      { icon: '&#128737;', label: 'SentryLion', href: 'sentrylion.html' }
    ]
  };
</script>
<script src="js/auth.js"></script>
<script src="js/nav.js"></script>
<script src="js/sentryfleet-db.js"></script>

<script>
/* ═══════════════════════════════════════════════════════════
   FLEET CONSOLE — Main Application Logic
   ═══════════════════════════════════════════════════════════ */
(function () {
  'use strict';

  // ── STATE ──
  var currentAgentId = null;
  var pendingCommand = null;
  var logUnsub = null;
  var cmdUnsub = null;

  // ── DOM REFS ──
  var fleetView = document.getElementById('fleetView');
  var fleetGrid = document.getElementById('fleetGrid');
  var detailView = document.getElementById('detailView');
  var emptyState = document.getElementById('emptyState');
  var cmdPanel = document.getElementById('cmdPanel');
  var confirmOverlay = document.getElementById('confirmOverlay');

  // ── FLEET STATS ──
  var statAgents = document.getElementById('statAgents');
  var statOnline = document.getElementById('statOnline');
  var statThreats = document.getElementById('statThreats');
  var statJailed = document.getElementById('statJailed');

  // ════════════════════════════════════════════════════════
  //  FLEET GRID RENDERING
  // ════════════════════════════════════════════════════════

  function renderFleet(agents) {
    var ids = Object.keys(agents || {});

    // Update top stats
    var online = 0, threats = 0, jailed = 0;
    ids.forEach(function (id) {
      var a = agents[id];
      if (a._computed_online) online++;
      if (a.threatLevel === 'HIGH' || a.threatLevel === 'CRITICAL') threats++;
      if (a.status === 'jailed') jailed++;
    });
    statAgents.textContent = ids.length;
    statOnline.textContent = online;
    statThreats.textContent = threats;
    statJailed.textContent = jailed;

    // Empty state
    if (ids.length === 0) {
      emptyState.style.display = 'flex';
      // Clear old cards but keep empty state
      var cards = fleetGrid.querySelectorAll('.agent-card');
      cards.forEach(function (c) { c.remove(); });
      return;
    }
    emptyState.style.display = 'none';

    // Build/update cards
    ids.forEach(function (id) {
      var a = agents[id];
      var card = document.getElementById('card-' + id);
      if (!card) {
        card = document.createElement('div');
        card.id = 'card-' + id;
        card.className = 'agent-card';
        card.onclick = function () { showDetail(id); };
        fleetGrid.appendChild(card);
      }

      var displayStatus = a._display_status || a.status || 'unknown';
      card.className = 'agent-card status-' + displayStatus;

      var badgeClass = 'badge-' + displayStatus;
      if (a.threatLevel === 'CRITICAL' && displayStatus === 'online') badgeClass = 'badge-critical';

      var cpu = a.cpuPercent || 0;
      var mem = a.memPercent || 0;
      var cpuClass = cpu > 80 ? 'bar-fill bar-cpu high' : 'bar-fill bar-cpu';
      var memClass = mem > 80 ? 'bar-fill bar-mem high' : 'bar-fill bar-mem';

      var hsScore = (a.hardening && a.hardening.score != null) ? a.hardening.score : '?';
      var hsClass = hsScore === '?' ? 'hs-warn' : (hsScore >= 71 ? 'hs-good' : (hsScore >= 41 ? 'hs-warn' : 'hs-bad'));

      var hbAge = formatAge(a._heartbeat_age);

      var probHtml = '';
      if (displayStatus === 'probation') {
        var probStage = 3; // TODO: read from Firestore probation doc
        probHtml = '<div class="probation-bar"><div class="probation-fill prob-stage-' + probStage + '"></div></div>';
      }

      card.innerHTML =
        '<div class="card-header">' +
          '<span class="card-hostname">' + esc(a.hostname || id) + '</span>' +
          '<span class="status-badge ' + badgeClass + '">' + displayStatus.toUpperCase() + '</span>' +
          '<span class="card-ip">' + esc(a.ip || '?') + '</span>' +
        '</div>' +
        '<div class="card-body">' +
          '<div class="card-row"><span class="label">CPU</span><div class="bar-bg"><div class="' + cpuClass + '" style="width:' + cpu + '%"></div></div><span class="val">' + cpu + '%</span></div>' +
          '<div class="card-row"><span class="label">MEM</span><div class="bar-bg"><div class="' + memClass + '" style="width:' + mem + '%"></div></div><span class="val">' + mem + '%</span></div>' +
          '<div class="card-meta">' +
            '<span class="meta-item"><span class="threat-indicator threat-' + (a.threatLevel || 'UNKNOWN') + '">' + (a.threatLevel || '?') + '</span></span>' +
            '<span class="meta-item"><span class="hardening-score ' + hsClass + '">HS:' + hsScore + '</span></span>' +
            '<span class="meta-item" style="color:var(--text-dim)">' + esc(a.os || '?') + '</span>' +
            (a.uptimeSecs ? '<span class="meta-item" style="color:var(--text-dim);font-size:10px" title="Uptime">&#8986; ' + formatUptime(a.uptimeSecs) + '</span>' : '') +
          '</div>' +
          probHtml +
        '</div>' +
        '<div class="card-heartbeat">&#9829; ' + hbAge + '</div>';
    });

    // Remove cards for agents that no longer exist
    var existingCards = fleetGrid.querySelectorAll('.agent-card');
    existingCards.forEach(function (card) {
      var cardId = card.id.replace('card-', '');
      if (!agents[cardId]) card.remove();
    });

    // Also update detail view if open
    if (currentAgentId && agents[currentAgentId]) {
      updateDetailInfo(agents[currentAgentId]);
    }
  }

  // ════════════════════════════════════════════════════════
  //  AGENT DETAIL VIEW
  // ════════════════════════════════════════════════════════

  function showDetail(agentId) {
    currentAgentId = agentId;
    var a = SentryFleet.getAgent(agentId);
    if (!a) return;

    fleetView.classList.add('hidden');
    detailView.classList.add('active');

    document.getElementById('detailHostname').textContent = a.hostname || agentId;
    document.getElementById('detailIP').textContent = a.ip || '?';

    updateDetailInfo(a);

    // Subscribe to live logs
    if (logUnsub) logUnsub();
    var logStream = document.getElementById('logStream');
    logStream.innerHTML = '<div style="padding:12px;color:var(--text-dim)">Loading logs...</div>';

    logUnsub = SentryFleet.subscribeToLogs(agentId, function (entries) {
      renderLogs(entries);
    }, 200);

    // If no real logs, show simulated placeholder
    setTimeout(function () {
      if (logStream.querySelector('div[style]')) {
        renderPlaceholderLogs(a);
      }
    }, 3000);

    // Load last command output
    loadLastCommand(agentId);
  }

  function loadLastCommand(agentId) {
    SentryFleet.getCommandHistory(agentId, 1).then(function (cmds) {
      if (!cmds.length) {
        document.getElementById('dLastCmdName').textContent = 'none';
        document.getElementById('dLastCmdStatus').textContent = '---';
        document.getElementById('dLastCmdTime').textContent = '---';
        document.getElementById('dLastCmdOutput').style.display = 'none';
        return;
      }
      var c = cmds[0];
      document.getElementById('dLastCmdName').textContent = c.command || '?';
      var statusEl = document.getElementById('dLastCmdStatus');
      statusEl.textContent = (c.status || '?').toUpperCase();
      statusEl.style.color = c.status === 'completed' ? 'var(--green)' : c.status === 'failed' ? 'var(--red)' : 'var(--yellow)';
      document.getElementById('dLastCmdTime').textContent = c.issued_at ? new Date(c.issued_at).toLocaleString() : '?';
      var outputEl = document.getElementById('dLastCmdOutput');
      if (c.output && c.output.length > 0) {
        outputEl.textContent = c.output;
        outputEl.style.display = 'block';
      } else {
        outputEl.style.display = 'none';
      }
    }).catch(function () {
      document.getElementById('dLastCmdName').textContent = '?';
    });
  }

  function updateDetailInfo(a) {
    document.getElementById('dOS').textContent = a.os || '?';
    document.getElementById('dStatus').textContent = (a._display_status || a.status || '?').toUpperCase();
    document.getElementById('dVersion').textContent = a.agentVersion || '?';
    document.getElementById('dHeartbeat').textContent = formatAge(a._heartbeat_age);
    document.getElementById('dUptime').textContent = formatUptime(a.uptimeSecs);
    document.getElementById('dProcesses').textContent = a.processCount || '?';
    document.getElementById('dTools').textContent = (a.installedTools || []).join(', ') || 'none';
    document.getElementById('dAI').textContent = a.aiTrainingStatus || '?';

    var tv = document.getElementById('dThreatVal');
    tv.textContent = a.threatLevel || 'UNKNOWN';
    tv.style.color = threatColor(a.threatLevel);

    var cpu = a.cpuPercent || 0;
    var mem = a.memPercent || 0;
    document.getElementById('dCPUBar').style.width = cpu + '%';
    document.getElementById('dCPUVal').textContent = cpu + '%';
    document.getElementById('dMEMBar').style.width = mem + '%';
    document.getElementById('dMEMVal').textContent = mem + '%';

    if (cpu > 80) document.getElementById('dCPUBar').className = 'bar-fill bar-cpu high';
    else document.getElementById('dCPUBar').className = 'bar-fill bar-cpu';
    if (mem > 80) document.getElementById('dMEMBar').className = 'bar-fill bar-mem high';
    else document.getElementById('dMEMBar').className = 'bar-fill bar-mem';

    document.getElementById('dMemDetail').textContent = formatMemory(a.memUsedMb, a.memTotalMb);

    var hs = a.hardening ? a.hardening.score : '?';
    var hsEl = document.getElementById('dHardenScore');
    hsEl.textContent = hs !== '?' ? hs + '/100' : '?';
    if (hs !== '?') {
      hsEl.style.color = hs >= 70 ? 'var(--green)' : hs >= 40 ? 'var(--yellow)' : 'var(--red)';
      hsEl.style.textShadow = hs >= 70 ? '0 0 8px var(--green-glow)' : hs >= 40 ? '0 0 8px rgba(234,179,8,0.4)' : '0 0 8px var(--red-glow)';
    }
    document.getElementById('dHardenDate').textContent = a.hardening && a.hardening.lastAudit
      ? new Date(a.hardening.lastAudit).toLocaleString() : '?';
  }

  function hideDetail() {
    currentAgentId = null;
    detailView.classList.remove('active');
    fleetView.classList.remove('hidden');
    if (logUnsub) { logUnsub(); logUnsub = null; }
    if (cmdUnsub) { cmdUnsub(); cmdUnsub = null; }
    closeCmdPanel();
  }

  // ════════════════════════════════════════════════════════
  //  LOG RENDERING
  // ════════════════════════════════════════════════════════

  function renderLogs(entries) {
    var logStream = document.getElementById('logStream');
    var html = '';
    entries.forEach(function (e) {
      var time = e.timestamp ? new Date(e.timestamp).toLocaleTimeString() : '??:??:??';
      var tag = e.tag || 'INFO';
      html += '<div class="log-entry">' +
        '<span class="log-time">' + time + '</span>' +
        '<span class="tag tag-' + esc(tag) + '">[' + esc(tag) + ']</span>' +
        '<span>' + esc(e.message || '') + '</span>' +
        '</div>';
    });
    logStream.innerHTML = html || '<div style="padding:12px;color:var(--text-dim)">No log entries</div>';
    document.getElementById('logCount').textContent = entries.length + ' entries';
  }

  function renderPlaceholderLogs(agent) {
    // Show simulated logs when no real Firestore data exists yet
    var tags = ['SHIELD', 'SCAN', 'THREAT', 'JAIL', 'YARA', 'SIGMA', 'ML', 'HARDEN'];
    var msgs = [
      'SentryLion agent initialized — monitoring active',
      'Heartbeat confirmed — all systems nominal',
      'YARA scan completed — 0 detections in 1,247 files',
      'Sigma rule check — 0 suspicious events in Security log',
      'ML anomaly score: 0.12 — within normal baseline',
      'Hardening score: ' + ((agent.hardening && agent.hardening.score) || '?') + '/100',
      'Network connections: 23 active, 0 suspicious',
      'CPU: ' + (agent.cpuPercent || 0) + '% | MEM: ' + (agent.memPercent || 0) + '%',
      'Canary files intact — no tampering detected',
      'Threat intel feeds refreshed — 12,847 IOCs loaded',
      'Process tree analysis — no anomalous parent-child chains',
      'Registry integrity check — all security keys intact'
    ];
    var entries = [];
    var now = Date.now();
    for (var i = 0; i < msgs.length; i++) {
      entries.push({
        timestamp: now - (i * 5000),
        tag: tags[i % tags.length],
        message: msgs[i]
      });
    }
    renderLogs(entries);
  }

  // ════════════════════════════════════════════════════════
  //  COMMAND PANEL
  // ════════════════════════════════════════════════════════

  function openCmdPanel() {
    cmdPanel.classList.add('open');
    document.getElementById('cmdTarget').textContent = currentAgentId
      ? (SentryFleet.getAgent(currentAgentId) || {}).hostname || currentAgentId
      : '---';
    loadCommandHistory();
  }

  function closeCmdPanel() {
    cmdPanel.classList.remove('open');
  }

  function loadCommandHistory() {
    if (!currentAgentId) return;
    SentryFleet.getCommandHistory(currentAgentId, 10).then(function (cmds) {
      var el = document.getElementById('cmdHistory');
      if (!cmds.length) {
        el.innerHTML = '<div style="font-size:10px;color:var(--text-dim);padding:8px">No commands sent yet</div>';
        return;
      }
      var html = '';
      cmds.forEach(function (c, i) {
        var time = new Date(c.issued_at).toLocaleTimeString();
        var hasOutput = c.output && c.output.length > 0;
        html += '<div>' +
          '<div class="cmd-history-item" onclick="toggleCmdOutput(\'cmdOut' + i + '\')" title="' + (hasOutput ? 'Click to view output' : 'No output') + '">' +
          '<span class="cmd-status-dot cmd-status-' + (c.status || 'pending') + '"></span>' +
          '<span style="flex:1">' + esc(c.command) + '</span>' +
          '<span style="color:var(--text-dim)">' + time + '</span>' +
          '<span style="color:var(--text-dim);min-width:60px;text-align:right">' + (c.status || '?') + '</span>' +
          (hasOutput ? '<span style="color:var(--cyan);font-size:9px">&#9660;</span>' : '') +
          '</div>' +
          (hasOutput ? '<div class="cmd-output-box" id="cmdOut' + i + '">' + esc(c.output) + '</div>' : '') +
          '</div>';
      });
      el.innerHTML = html;
    }).catch(function (err) {
      console.warn('[Console] Command history load failed:', err);
      document.getElementById('cmdHistory').innerHTML =
        '<div style="font-size:10px;color:var(--text-dim);padding:8px">Could not load command history</div>';
    });
  }

  // ════════════════════════════════════════════════════════
  //  COMMAND CONFIRMATION + DISPATCH
  // ════════════════════════════════════════════════════════

  var COMMAND_CONFIG = {
    'restart':         { title: 'Restart Computer',        msg: 'This will restart the remote computer with a 30-second warning.', input: false },
    'shutdown':        { title: 'Shutdown Computer',       msg: 'This will shut down the remote computer with a 60-second warning.', input: false },
    'send_message':    { title: 'Send Message',            msg: 'Enter the message to display on the remote screen:', input: true, placeholder: 'Your message here...' },
    'ipconfig_renew':  { title: 'IP Release / Renew',      msg: 'This will release and renew the IP address. Network will drop briefly.', input: false },
    'ipconfig':        { title: 'IP Config',               msg: 'Show full network adapter configuration (ipconfig /all).', input: false },
    'sysinfo':         { title: 'System Info',             msg: 'Get OS version, hardware details, uptime, and installed hotfixes.', input: false },
    'tasklist':        { title: 'Task List',               msg: 'Get list of running processes (top 80 by memory).', input: false },
    'netstat':         { title: 'Netstat',                 msg: 'Show active TCP connections and listening ports.', input: false },
    'whoami':          { title: 'Who Am I',                msg: 'Show current user, group memberships, and privileges.', input: false },
    'full-scan':       { title: 'Force Full Scan',         msg: 'Run YARA + Sigma + ML anomaly detection. May take several minutes.', input: false },
    'hardening_audit':  { title: 'Hardening Audit',         msg: 'Run GPO analysis + registry checks + HardeningKitty audit.', input: false },
    'auto_harden':      { title: 'Auto-Harden System',     msg: 'Apply security fixes: disable SMBv1, WDigest, AutoRun, LLMNR, NetBIOS; enable PS logging, LSA protection, firewall. Requires admin.', input: false },
    'temp_cleanup':     { title: 'Strategic Temp Cleanup',  msg: 'Execute 4-phase cleanup: persistence removal → process suspension → file deletion → verification.', input: false },
    'adwcleaner':      { title: 'Run AdwCleaner',          msg: 'Run portable AdwCleaner scan and clean. Agent may reboot after cleanup.', input: false },
    'emsisoft':        { title: 'Run Emsisoft EEK',        msg: 'Run full Emsisoft Emergency Kit scan. This will take several minutes.', input: false },
    'isolate':         { title: 'ISOLATE Machine',         msg: 'WARNING: This will block ALL network traffic except Firebase heartbeat via Windows Firewall rules. The machine will be completely isolated.', input: false },
    'unisolate':       { title: 'Remove Isolation',        msg: 'This will remove all SentryLion firewall isolation rules and restore normal network access.', input: false },
    'kill-connection': { title: 'Kill Connection',         msg: 'Enter the remote IP address to terminate:', input: true, placeholder: '10.0.0.1' },
    'start-probation': { title: 'Start Probation',        msg: 'Begin 3-minute graduated network restoration. The agent will slowly re-enable connectivity through 6 stages.', input: false },
    'push-file':       { title: 'Push & Execute File',    msg: 'The agent will download and execute the file at the specified URL.', input: false }
  };

  window.confirmCommand = function (type) {
    if (!currentAgentId) return;
    var cfg = COMMAND_CONFIG[type];
    if (!cfg) return;

    pendingCommand = type;
    document.getElementById('confirmTitle').textContent = cfg.title;
    document.getElementById('confirmMsg').textContent = cfg.msg;

    var inputWrap = document.getElementById('confirmInput');
    var inputField = document.getElementById('confirmInputField');
    if (cfg.input) {
      inputWrap.style.display = 'block';
      inputField.placeholder = cfg.placeholder || '';
      inputField.value = '';
      inputField.focus();
    } else {
      inputWrap.style.display = 'none';
    }

    confirmOverlay.classList.add('active');
  };

  window.toggleCmdOutput = function (id) {
    var el = document.getElementById(id);
    if (el) el.classList.toggle('open');
  };

  window.closeConfirm = function () {
    confirmOverlay.classList.remove('active');
    pendingCommand = null;
  };

  document.getElementById('confirmYes').addEventListener('click', function () {
    if (!pendingCommand || !currentAgentId) return;

    var payload = {};
    var inputField = document.getElementById('confirmInputField');
    var type = pendingCommand;

    if (type === 'send_message') {
      payload.message = inputField.value || 'Hello from SentryLion Console';
    } else if (type === 'kill-connection') {
      payload.ip = inputField.value || '';
    } else if (type === 'push-file') {
      payload.url = document.getElementById('pushFileUrl').value || '';
      if (!payload.url) { alert('Please enter a file URL'); return; }
    }

    closeConfirm();

    // Special case: probation uses dedicated function
    if (type === 'start-probation') {
      SentryFleet.startProbation(currentAgentId).then(function () {
        console.log('[Console] Probation started');
        loadCommandHistory();
      });
      return;
    }

    // Send command via SentryFleet
    SentryFleet.sendCommand(currentAgentId, type, payload).then(function (cmdId) {
      console.log('[Console] Command sent: ' + type + ' → ' + cmdId);
      loadCommandHistory();
    }).catch(function (err) {
      console.error('[Console] Command failed:', err);
      alert('Command failed: ' + err.message);
    });
  });

  // ════════════════════════════════════════════════════════
  //  UTILITIES
  // ════════════════════════════════════════════════════════

  function esc(str) {
    if (!str) return '';
    var d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  function formatAge(ms) {
    if (!ms || ms === Infinity) return 'never';
    if (ms < 10000) return 'just now';
    if (ms < 60000) return Math.floor(ms / 1000) + 's ago';
    if (ms < 3600000) return Math.floor(ms / 60000) + 'm ago';
    if (ms < 86400000) return Math.floor(ms / 3600000) + 'h ago';
    return Math.floor(ms / 86400000) + 'd ago';
  }

  function formatUptime(secs) {
    if (!secs || secs <= 0) return '?';
    var d = Math.floor(secs / 86400);
    var h = Math.floor((secs % 86400) / 3600);
    var m = Math.floor((secs % 3600) / 60);
    if (d > 0) return d + 'd ' + h + 'h';
    if (h > 0) return h + 'h ' + m + 'm';
    return m + 'm';
  }

  function formatMemory(usedMb, totalMb) {
    if (!totalMb) return '?';
    var usedGb = (usedMb / 1024).toFixed(1);
    var totalGb = (totalMb / 1024).toFixed(1);
    return usedGb + ' / ' + totalGb + ' GB';
  }

  function threatColor(level) {
    switch (level) {
      case 'LOW': return 'var(--green)';
      case 'MODERATE': return 'var(--yellow)';
      case 'HIGH': return 'var(--orange)';
      case 'CRITICAL': return 'var(--red)';
      default: return 'var(--text-dim)';
    }
  }

  // ════════════════════════════════════════════════════════
  //  EVENT WIRING
  // ════════════════════════════════════════════════════════

  document.getElementById('btnBack').addEventListener('click', hideDetail);
  document.getElementById('btnCommands').addEventListener('click', openCmdPanel);
  document.getElementById('cmdClose').addEventListener('click', closeCmdPanel);

  document.getElementById('btnSeedDemo').addEventListener('click', function () {
    if (!window.SentryFleet) { alert('SentryFleet not initialized'); return; }
    SentryFleet.seedDemoAgents().then(function () {
      console.log('[Console] Demo agents seeded');
    }).catch(function (err) {
      console.error('[Console] Demo seed failed:', err);
      alert('Demo seed failed — check Firebase RTDB is enabled. Error: ' + err.message);
    });
  });

  document.getElementById('btnDeploy').addEventListener('click', function () {
    alert('USB Deploy coming in Phase 9.\n\nThis will generate a SentryLion-Portable.zip containing:\n- SentryLion.exe (Tauri agent)\n- AdwCleaner + Emsisoft EEK\n- YARA + Sigma rules\n- Pre-trained ML model\n- HardeningKitty baselines');
  });

  // ════════════════════════════════════════════════════════
  //  INITIALIZATION
  // ════════════════════════════════════════════════════════

  function initConsole() {
    console.log('[Console] Initializing Fleet Console...');

    // Wait for SentryFleet to be ready
    if (window.SentryFleet) {
      SentryFleet.on('ready', function () {
        console.log('[Console] SentryFleet ready — subscribing to agents');
        SentryFleet.subscribeToAgents(renderFleet);
      });

      // If already initialized (race condition), subscribe immediately
      if (SentryFleet.getAgents && Object.keys(SentryFleet.getAgents()).length > 0) {
        SentryFleet.subscribeToAgents(renderFleet);
      }
    }

    // Also listen for auth event (SentryFleet auto-inits on fpcs-authed)
    document.addEventListener('fpcs-authed', function () {
      setTimeout(function () {
        if (window.SentryFleet) {
          SentryFleet.subscribeToAgents(renderFleet);
        }
      }, 500);
    });
  }

  // Start when DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initConsole);
  } else {
    initConsole();
  }

})();
</script>
</body>
</html>
