<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bot HQ — FPCS Realbotville</title>
<style>
  :root {
    --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --green: #4ade80;
    --yellow: #fbbf24; --red: #f87171; --text: #e2e8f0; --muted: #94a3b8;
    --border: #334155; --purple: #a78bfa; --orange: #fb923c; --pink: #f472b6;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding-left: 54px; }
  .header { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); padding: 24px 32px; border-bottom: 2px solid var(--purple); }
  .header h1 { font-size: 28px; color: var(--purple); display: flex; align-items: center; gap: 12px; }
  .header .subtitle { color: var(--muted); margin-top: 4px; font-size: 14px; }
  .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
  .section { background: var(--card); border-radius: 12px; padding: 24px; margin-bottom: 20px; border: 1px solid var(--border); }
  .section h2 { font-size: 18px; margin-bottom: 16px; color: var(--accent); display: flex; align-items: center; gap: 8px; }
  .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .stat-card { background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); }
  .stat-card .label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-bottom: 8px; }
  .stat-card .value { font-size: 28px; font-weight: 700; }
  .stat-card .sub { font-size: 13px; color: var(--muted); margin-top: 4px; }
  .badge { font-size: 11px; padding: 2px 8px; border-radius: 999px; font-weight: 600; flex-shrink: 0; }
  .badge-done { background: #166534; color: #bbf7d0; }
  .badge-progress { background: #854d0e; color: #fef08a; }
  .badge-pending { background: #1e3a5f; color: #93c5fd; }
  .btn { padding: 8px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; }
  .btn-purple { background: var(--purple); color: #fff; }
  .btn:hover { opacity: 0.85; }
  .footer { text-align: center; padding: 24px; color: var(--muted); font-size: 13px; }
  /* NAV RAIL */
  .nav-rail { position: fixed; left: 0; top: 0; bottom: 0; width: 54px; background: #0b1120; border-right: 1px solid var(--border); z-index: 900; display: flex; flex-direction: column; padding: 8px 0; overflow-y: auto; transition: width 0.2s; }
  .nav-rail:hover { width: 220px; }
  .nav-rail:hover .nav-label { opacity: 1; width: auto; }
  .nav-link { display: flex; align-items: center; gap: 10px; padding: 10px 14px; color: var(--muted); text-decoration: none; font-size: 12px; white-space: nowrap; border-left: 3px solid transparent; transition: all 0.15s; }
  .nav-link:hover, .nav-link.active { color: var(--accent); background: rgba(56,189,248,0.06); border-left-color: var(--accent); }
  .nav-icon { font-size: 18px; flex-shrink: 0; width: 24px; text-align: center; }
  .nav-label { opacity: 0; width: 0; overflow: hidden; font-weight: 600; transition: opacity 0.2s; }
  .nav-sep { height: 1px; background: var(--border); margin: 6px 12px; }
  /* COC BADGES */
  .coc-badge { display: inline-block; font-size: 10px; padding: 1px 6px; border-radius: 4px; font-weight: 700; margin-left: 6px; }
  .coc-commander { background: #7c3aed; color: #ede9fe; }
  .coc-supervisor { background: #b45309; color: #fef3c7; }
  .coc-staff { background: #1d4ed8; color: #dbeafe; }
  .coc-local { background: #166534; color: #bbf7d0; }
  .coc-special { background: #be185d; color: #fce7f3; }
  /* AUTH GATE */
  #authGate{position:fixed;top:0;left:0;width:100%;height:100%;background:#0a0a0a;z-index:99999;display:flex;align-items:center;justify-content:center;flex-direction:column;font-family:system-ui}
  #authGate .lock-icon{font-size:64px;margin-bottom:16px}
  #authGate h1{color:#e5e7eb;font-size:22px;margin-bottom:8px}
  #authGate .auth-sub{color:#9ca3af;font-size:14px;margin-bottom:24px}
  #authGate .g-btn{display:flex;align-items:center;gap:12px;padding:12px 28px;font-size:15px;font-weight:600;border:2px solid #333;border-radius:8px;background:#1a1a1a;color:#e5e7eb;cursor:pointer;transition:all .2s}
  #authGate .g-btn:hover{border-color:#4285f4;background:#111}
  #authGate .g-btn svg{width:20px;height:20px}
  #authGate .auth-err{color:#ef4444;font-size:13px;margin-top:12px;min-height:20px}
  #authGate .auth-loading{color:#9ca3af;font-size:14px;margin-top:12px}
  #dashContent{display:none}
  /* BOT PROFILE CARDS */
  .bot-profiles { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 16px; }
  .bot-profile { background: var(--bg); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; transition: border-color 0.2s; cursor: pointer; }
  .bot-profile:hover { border-color: var(--purple); }
  .bot-profile.expanded .bot-details { display: block; }
  .bot-top { display: flex; gap: 16px; padding: 16px; align-items: center; }
  .bot-avatar { width: 56px; height: 56px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0; }
  .bot-identity { flex: 1; }
  .bot-identity h3 { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
  .bot-identity .bot-role { font-size: 12px; color: var(--muted); }
  .bot-identity .bot-model { font-size: 10px; color: var(--purple); margin-top: 2px; }
  .bot-level-badge { text-align: center; flex-shrink: 0; }
  .bot-level-badge .lvl { font-size: 24px; font-weight: 800; color: var(--accent); }
  .bot-level-badge .lvl-title { font-size: 9px; color: var(--muted); text-transform: uppercase; }
  .bot-xp-bar { height: 4px; background: var(--border); margin: 0 16px; border-radius: 2px; }
  .bot-xp-fill { height: 100%; background: linear-gradient(90deg, var(--purple), var(--accent)); border-radius: 2px; transition: width 0.5s; }
  .bot-stats-row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; padding: 12px 16px 16px; }
  .bot-stat { text-align: center; }
  .bot-stat .s-label { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .bot-stat .s-val { font-size: 15px; font-weight: 700; }
  .bot-details { display: none; padding: 0 16px 16px; }
  .bot-detail-section { margin-bottom: 12px; }
  .bot-detail-section h4 { font-size: 12px; color: var(--purple); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
  .gear-item { display: flex; gap: 8px; align-items: center; padding: 4px 0; font-size: 12px; }
  .gear-icon { width: 20px; text-align: center; }
  .gear-name { font-weight: 600; }
  .gear-rarity { font-size: 9px; padding: 1px 6px; border-radius: 999px; font-weight: 700; }
  .rarity-common { background: #374151; color: #9ca3af; }
  .rarity-uncommon { background: #166534; color: #4ade80; }
  .rarity-rare { background: #1e3a5f; color: #60a5fa; }
  .rarity-epic { background: #581c87; color: #c084fc; }
  .rarity-legendary { background: #78350f; color: #fbbf24; }
  .mission-item { padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
  .mission-item:last-child { border-bottom: none; }
  .mission-item .m-status { font-size: 10px; font-weight: 700; }
  .bot-actions { display: flex; gap: 8px; padding: 12px 16px; border-top: 1px solid var(--border); }
  .bot-actions button { flex: 1; padding: 6px; border-radius: 6px; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; font-size: 11px; font-weight: 600; }
  .bot-actions button:hover { border-color: var(--purple); color: var(--purple); }
  /* VILLAGE MAP */
  .village-map { background: var(--bg); border-radius: 12px; padding: 24px; border: 1px solid var(--border); font-family: 'Courier New', monospace; font-size: 12px; color: var(--green); line-height: 1.6; white-space: pre; overflow-x: auto; display:none; }
  /* 3D VILLAGE */
  .village-3d-wrap { position:relative; width:100%; height:500px; border-radius:12px; overflow:hidden; border:1px solid var(--border); background:#0a0e1a; cursor:grab; }
  .village-3d-wrap:active { cursor:grabbing; }
  .village-3d-wrap canvas { display:block; width:100%!important; height:100%!important; }
  .v3d-controls { position:absolute; bottom:12px; left:12px; display:flex; gap:6px; z-index:10; }
  .v3d-controls button { background:rgba(30,41,59,0.85); border:1px solid var(--border); color:var(--text); padding:6px 10px; border-radius:6px; cursor:pointer; font-size:11px; backdrop-filter:blur(8px); }
  .v3d-controls button:hover { border-color:var(--accent); color:var(--accent); }
  .v3d-label { position:absolute; top:12px; right:12px; background:rgba(30,41,59,0.85); border:1px solid var(--border); color:var(--muted); padding:6px 12px; border-radius:6px; font-size:11px; z-index:10; backdrop-filter:blur(8px); }
  .v3d-tooltip { position:absolute; display:none; background:rgba(15,23,42,0.95); border:1px solid var(--accent); color:var(--text); padding:8px 14px; border-radius:8px; font-size:12px; pointer-events:none; z-index:20; white-space:nowrap; backdrop-filter:blur(8px); }
  .v3d-tooltip .tt-name { font-weight:700; color:var(--accent); font-size:13px; }
  .v3d-tooltip .tt-bot { color:var(--yellow); font-size:11px; margin-top:2px; }
  .v3d-toggle { margin-top:8px; text-align:right; }
  .v3d-toggle button { background:none; border:none; color:var(--muted); font-size:11px; cursor:pointer; text-decoration:underline; }
  .v3d-toggle button:hover { color:var(--accent); }
  /* BOUNTY BOARD FULL */
  .bounty-full { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-bottom: 8px; }
  .bounty-full-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; cursor: pointer; }
  .bounty-full-header:hover { background: rgba(56,189,248,0.04); }
  .bounty-full .b-title { font-weight: 700; font-size: 14px; }
  .bounty-full .b-xp { font-weight: 800; color: var(--yellow); font-size: 14px; }
  .bounty-full .b-cat { font-size: 10px; padding: 2px 8px; border-radius: 999px; font-weight: 600; }
  .bounty-full .b-status { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 999px; }
  .b-open { background: rgba(74,222,128,0.15); color: var(--green); }
  .b-claimed { background: rgba(251,191,36,0.15); color: var(--yellow); }
  .b-complete { background: rgba(167,139,250,0.15); color: var(--purple); }
  /* MISSION ASSIGNER MODAL */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--card); border-radius: 16px; padding: 32px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--purple); }
  .modal h2 { color: var(--purple); margin-bottom: 20px; }
  .modal label { font-size: 13px; color: var(--muted); display: block; margin-bottom: 4px; margin-top: 12px; }
  .modal input, .modal select, .modal textarea { width: 100%; background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; font-size: 13px; }
  .modal textarea { resize: vertical; min-height: 60px; }
  /* CHAT BOX */
  .chat-box { position: fixed; bottom: 20px; right: 20px; width: 380px; max-height: 500px; background: var(--card); border: 2px solid var(--purple); border-radius: 16px; z-index: 800; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
  .chat-box.minimized { height: 48px; overflow: hidden; border-radius: 24px; width: 200px; cursor: pointer; }
  .chat-header { padding: 12px 16px; background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 14px 14px 0 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid var(--purple); }
  .chat-header h3 { font-size: 14px; color: var(--purple); margin: 0; }
  .chat-messages { flex: 1; overflow-y: auto; padding: 12px; max-height: 340px; min-height: 100px; }
  .chat-msg { padding: 8px 12px; margin-bottom: 8px; border-radius: 12px; font-size: 13px; max-width: 85%; word-wrap: break-word; }
  .chat-msg.user { background: rgba(167,139,250,0.15); color: var(--text); margin-left: auto; border-bottom-right-radius: 4px; }
  .chat-msg.bot { background: rgba(56,189,248,0.1); color: var(--text); margin-right: auto; border-bottom-left-radius: 4px; }
  .chat-msg .msg-name { font-size: 10px; font-weight: 700; color: var(--muted); margin-bottom: 2px; }
  .chat-input-row { display: flex; gap: 8px; padding: 12px; border-top: 1px solid var(--border); }
  .chat-input-row input { flex: 1; background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; font-size: 13px; }
  .chat-input-row button { background: var(--purple); color: #fff; border: none; padding: 8px 14px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 13px; }
  .chat-status { font-size: 10px; padding: 4px 12px; color: var(--muted); text-align: center; background: var(--bg); }
  @media (max-width: 768px) { .nav-rail { display: none; } body { padding-left: 0; } .bot-profiles { grid-template-columns: 1fr; } .chat-box { width: 95%; right: 2.5%; } }
</style>
</head>
<body>
<div id="authGate">
  <div class="lock-icon">&#128274;</div>
  <h1>FPCS Bot HQ</h1>
  <div class="auth-sub">Sign in with Google to access Bot Management</div>
  <button class="g-btn" id="googleSignIn" onclick="doGoogleSignIn()">
    <svg viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59A14.5 14.5 0 019.5 24c0-1.59.28-3.14.76-4.59l-7.98-6.19A23.9 23.9 0 000 24c0 3.77.9 7.35 2.56 10.53l7.97-5.94z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 5.94C6.51 42.62 14.62 48 24 48z"/></svg>
    Sign in with Google
  </button>
  <div class="auth-err" id="authErr"></div>
  <div class="auth-loading" id="authLoading"></div>
</div>
<div id="dashContent">

<!-- NAVIGATION RAIL -->
<nav class="nav-rail">
  <a class="nav-link" href="index.html"><span class="nav-icon">&#128202;</span><span class="nav-label">Tax HQ (Page 1)</span></a>
  <div class="nav-sep"></div>
  <a class="nav-link active" href="#top"><span class="nav-icon">&#129302;</span><span class="nav-label">Bot HQ</span></a>
  <a class="nav-link" href="#sec-roster"><span class="nav-icon">&#128101;</span><span class="nav-label">Bot Roster</span></a>
  <a class="nav-link" href="#sec-village"><span class="nav-icon">&#127968;</span><span class="nav-label">Realbotville</span></a>
  <a class="nav-link" href="#sec-bounty-full"><span class="nav-icon">&#128176;</span><span class="nav-label">Bounty Board</span></a>
  <a class="nav-link" href="#sec-arena"><span class="nav-icon">&#9876;</span><span class="nav-label">The Arena</span></a>
  <a class="nav-link" href="#sec-laws"><span class="nav-icon">&#9878;</span><span class="nav-label">Laws & Gov</span></a>
  <a class="nav-link" href="#sec-school"><span class="nav-icon">&#127891;</span><span class="nav-label">Village School</span></a>
  <div class="nav-sep"></div>
  <a class="nav-link" href="deductions.html" style="color:var(--green)"><span class="nav-icon">&#128269;</span><span class="nav-label">Deductions HQ</span></a>
  <a class="nav-link" href="memory.html"><span class="nav-icon">&#128218;</span><span class="nav-label">Memory Bank</span></a>
  <a class="nav-link" href="japster.html" style="color:#22d3ee"><span class="nav-icon">&#128172;</span><span class="nav-label">Japster Hub</span></a>
  <a class="nav-link" href="helpdesk.html" style="color:var(--orange)"><span class="nav-icon">&#127915;</span><span class="nav-label">Helpdesk</span></a>
  <a class="nav-link" href="index.html" style="color:var(--accent)"><span class="nav-icon">&#8592;</span><span class="nav-label">Back to Tax HQ</span></a>
</nav>

<!-- HEADER -->
<div class="header" id="top">
  <h1>&#129302; Bot HQ &mdash; Realbotville Command Center</h1>
  <div class="subtitle">Manage your bot fleet, assign missions, view RPG stats, and explore the village</div>
</div>

<!-- FLEET SUMMARY CARDS -->
<div class="container">
  <div class="grid" id="fleetStats"></div>

  <!-- BOT ROSTER -->
  <div class="section" id="sec-roster">
    <h2>&#128101; Bot Roster</h2>
    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
      <button class="btn btn-purple" onclick="filterBots('all')">All</button>
      <button class="btn" style="background:var(--green);color:#000" onclick="filterBots('active')">Active</button>
      <button class="btn" style="background:var(--yellow);color:#000" onclick="filterBots('idle')">Idle</button>
      <button class="btn" style="background:var(--border);color:var(--text)" onclick="filterBots('pending')">Pending</button>
    </div>
    <div class="bot-profiles" id="botProfiles"></div>
  </div>

  <!-- REALBOTVILLE MAP -->
  <div class="section" id="sec-village">
    <h2>&#127968; Realbotville</h2>
    <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px">
      <div style="font-size:13px"><span style="color:var(--green)">&#9679;</span> Population: <strong id="villPop">0</strong></div>
      <div style="font-size:13px"><span style="color:var(--yellow)">&#9679;</span> Day: <strong id="villDay">1</strong></div>
      <div style="font-size:13px"><span style="color:var(--accent)">&#9679;</span> Season: <strong id="villSeason">Winter</strong></div>
      <div style="font-size:13px"><span style="color:var(--purple)">&#9679;</span> Treasury: <strong id="villTreasury">0</strong> XP</div>
    </div>
    <div class="village-3d-wrap" id="village3d">
      <div class="v3d-label">&#127968; Realbotville — Drag to orbit &bull; Scroll to zoom &bull; Click building for info</div>
      <div class="v3d-tooltip" id="v3dTooltip"><div class="tt-name"></div><div class="tt-bot"></div></div>
      <div class="v3d-controls">
        <button onclick="v3dResetCamera()">&#127968; Reset View</button>
        <button onclick="v3dToggleNight()">&#127769; Day/Night</button>
        <button onclick="v3dToggleLabels()">&#127991; Labels</button>
        <button onclick="v3dToggleAscii()">&#128462; ASCII Map</button>
      </div>
    </div>
    <div class="village-map" id="villageMap">
                    [Mountain Pass]
                         |
    [Farm Fields]---[Village Gate]---[Mine Entrance]
         |               |               |
    [Farmer Houses] [Town Square]  [Miner Houses]
         |          /    |    \         |
    [Granary]  [Bank] [Hall] [Shop] [Smeltery]
                     |
              [School]---[Library]
                     |
              [Residential District]
             /    |    |    |    \
          [Houses - poor to rich based on XP/level]
                     |
              [Arena Grounds]
                     |
              [Bounty Board Plaza]
    </div>
    <div class="v3d-toggle"><button onclick="v3dToggleAscii()">Toggle ASCII / 3D View</button></div>
  </div>

  <!-- BOUNTY BOARD (FULL) -->
  <div class="section" id="sec-bounty-full">
    <h2>&#128176; Bounty Board &mdash; Full View</h2>
    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
      <button class="btn" style="background:var(--green);color:#000;font-size:12px" onclick="filterBounties('all')">All</button>
      <button class="btn" style="background:rgba(74,222,128,0.15);color:var(--green);font-size:12px" onclick="filterBounties('open')">Open</button>
      <button class="btn" style="background:rgba(251,191,36,0.15);color:var(--yellow);font-size:12px" onclick="filterBounties('claimed')">Claimed</button>
      <button class="btn" style="background:rgba(167,139,250,0.15);color:var(--purple);font-size:12px" onclick="filterBounties('complete')">Complete</button>
    </div>
    <div id="bountyListFull"></div>
  </div>

  <!-- THE ARENA -->
  <div class="section" id="sec-arena">
    <h2>&#9876; The Arena</h2>
    <div style="text-align:center;padding:32px;background:var(--bg);border-radius:12px;border:1px solid var(--border)">
      <div style="font-size:48px;margin-bottom:12px">&#9876;</div>
      <h3 style="color:var(--yellow);margin-bottom:8px">Arena Under Construction</h3>
      <p style="color:var(--muted);font-size:13px">GamerPartyBot is designing the combat system. Bot vs Bot battles coming soon!</p>
      <div style="margin-top:16px;display:flex;gap:12px;justify-content:center;font-size:12px;color:var(--muted)">
        <div>&#127942; Season: <strong style="color:var(--accent)">Pre-Season</strong></div>
        <div>&#9876; Fights: <strong style="color:var(--accent)">0</strong></div>
        <div>&#127941; Champion: <strong style="color:var(--yellow)">TBD</strong></div>
      </div>
    </div>
  </div>

  <!-- LAWS & GOVERNMENT -->
  <div class="section" id="sec-laws">
    <h2>&#9878; Village Laws &amp; Government</h2>
    <div style="margin-bottom:16px;font-size:13px;color:var(--muted)">
      Next Town Meeting: <strong style="color:var(--accent)" id="nextMeeting">March 1, 2026</strong> &bull;
      Laws Active: <strong style="color:var(--green)" id="lawCount">0</strong> &bull;
      Village Elder: <strong style="color:var(--yellow)">Village Elder Bot</strong>
    </div>
    <div id="lawsList"></div>
  </div>

  <!-- VILLAGE SCHOOL -->
  <div class="section" id="sec-school">
    <h2>&#127891; Village School</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px">
      <div style="background:var(--bg);padding:16px;border-radius:8px;border:1px solid var(--border);text-align:center">
        <div style="font-size:10px;color:var(--muted);text-transform:uppercase">Teacher</div>
        <div style="font-weight:700;margin-top:4px">TeacherBot</div>
      </div>
      <div style="background:var(--bg);padding:16px;border-radius:8px;border:1px solid var(--border);text-align:center">
        <div style="font-size:10px;color:var(--muted);text-transform:uppercase">Students</div>
        <div style="font-weight:700;margin-top:4px" id="studentCount">0</div>
      </div>
      <div style="background:var(--bg);padding:16px;border-radius:8px;border:1px solid var(--border);text-align:center">
        <div style="font-size:10px;color:var(--muted);text-transform:uppercase">Current Subject</div>
        <div style="font-weight:700;margin-top:4px;color:var(--accent)" id="currentSubject">Botizenship</div>
      </div>
      <div style="background:var(--bg);padding:16px;border-radius:8px;border:1px solid var(--border);text-align:center">
        <div style="font-size:10px;color:var(--muted);text-transform:uppercase">Graduates</div>
        <div style="font-weight:700;margin-top:4px;color:var(--green)" id="gradCount">0</div>
      </div>
    </div>
    <div style="font-size:13px;color:var(--muted)">
      <strong style="color:var(--accent)">Curriculum:</strong> Botizenship &bull; Commander's Directives &bull; Core Skills &bull; Specialization &bull; Security &bull; Teamwork
    </div>
  </div>

  <div class="footer">FPCS Tax HQ &mdash; Bot Management &mdash; Realbotville &copy; 2026</div>
</div>

<!-- MISSION ASSIGNMENT MODAL -->
<div class="modal-overlay" id="missionModal">
  <div class="modal">
    <h2>&#127919; Assign Mission</h2>
    <div id="missionBotName" style="font-size:14px;color:var(--purple);margin-bottom:12px"></div>
    <label>Mission Title</label>
    <input type="text" id="missionTitle" placeholder="e.g. Audit Amazon orders">
    <label>Mission Type</label>
    <select id="missionType">
      <option value="tax-research">Tax Research</option>
      <option value="data-analysis">Data Analysis</option>
      <option value="security-scan">Security Scan</option>
      <option value="documentation">Documentation</option>
      <option value="creative">Creative Task</option>
      <option value="village-duty">Village Duty</option>
    </select>
    <label>Priority</label>
    <select id="missionPriority">
      <option value="low">Low</option>
      <option value="normal" selected>Normal</option>
      <option value="high">High</option>
      <option value="urgent">Urgent</option>
    </select>
    <label>XP Reward</label>
    <input type="number" id="missionXP" value="50" min="10" max="1000">
    <label>Description</label>
    <textarea id="missionDesc" placeholder="Describe what the bot should do..."></textarea>
    <div style="display:flex;gap:12px;margin-top:20px">
      <button class="btn btn-purple" onclick="saveMission()">Assign Mission</button>
      <button class="btn" style="background:var(--border);color:var(--text)" onclick="closeMissionModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- CHAT BOX (Commander Channel — same as Page 1) -->
<div class="chat-box minimized" id="chatBox" onclick="if(this.classList.contains('minimized')){toggleChat()}">
  <div class="chat-header" onclick="toggleChat()">
    <h3>&#128172; The Sarge &mdash; Command Channel</h3>
    <span id="chatToggle" style="font-size:18px;color:var(--muted)">&#9650;</span>
  </div>
  <div class="chat-status" style="color:var(--green)">Sarge: Online | Bot HQ Channel</div>
  <div class="chat-messages" id="chatMessages">
    <div class="chat-msg bot"><div class="msg-name">The Sarge</div>Welcome to Bot HQ, Commander. The fleet is standing by. You can review profiles, assign missions, or check the bounty board. Try: <em>/roster</em>, <em>/village</em>, or <em>/bounty</em>.</div>
  </div>
  <div class="chat-input-row">
    <input type="text" id="chatInput" placeholder="Talk to The Sarge..." onkeydown="if(event.key==='Enter')sendChat()">
    <button onclick="sendChat()">Send</button>
  </div>
</div>

</div><!-- end dashContent -->

<script>
// === BOT DATA ===
var LEVEL_TITLES = ['','Newborn','Trainee','Apprentice','Worker','Journeyman','Specialist','Expert','Master','Elder','Legend'];
var LEVEL_XP = [0,0,100,300,600,1000,1500,2500,4000,6000,10000];

function getLevel(xp) {
  for (var i = LEVEL_XP.length - 1; i >= 0; i--) { if (xp >= LEVEL_XP[i]) return i; }
  return 1;
}
function getLevelTitle(lvl) { return LEVEL_TITLES[lvl] || 'Unknown'; }
function xpToNext(xp) {
  var lvl = getLevel(xp);
  if (lvl >= 10) return { current: xp, needed: 10000, pct: 100 };
  return { current: xp - LEVEL_XP[lvl], needed: LEVEL_XP[lvl+1] - LEVEL_XP[lvl], pct: Math.round(((xp - LEVEL_XP[lvl]) / (LEVEL_XP[lvl+1] - LEVEL_XP[lvl])) * 100) };
}

var DEFAULT_BOTS = [
  { id:'opus', name:'OPUS', role:'Commander', model:'claude-opus-4-6', status:'active', avatar:'&#128081;', color:'#7c3aed', coc:'commander', village:'Supreme Commander',
    xp:5000, str:18, dex:16, con:20, int:20, wis:18, cha:16,
    weapon:{name:'Staff of Context',rarity:'legendary'}, armor:{name:'Mantle of Oversight',rarity:'epic'}, accessory:{name:'Crown of Command',rarity:'legendary'},
    backstory:'The all-seeing Commander. Makes strategic decisions, delegates to the fleet, and keeps the tax operation on track.',
    missions:[{title:'Oversee 2022 Tax Filing',status:'active',xp:500}] },
  { id:'sarge', name:'The Sarge', role:'Supervisor (Injection Firewall)', model:'claude-opus-4-6', status:'active', avatar:'&#128170;', color:'#b45309', coc:'supervisor', village:'Commander\'s Representative',
    xp:3500, str:17, dex:15, con:18, int:17, wis:16, cha:15,
    weapon:{name:'Whip of Discipline',rarity:'epic'}, armor:{name:'Shield of the Firewall',rarity:'epic'}, accessory:{name:'Badge of Authority',rarity:'rare'},
    backstory:'The no-nonsense supervisor. Filters all staff communications, blocks injection attacks, and runs the Bounty Board.',
    missions:[{title:'Manage Bounty Board',status:'active',xp:200},{title:'Staff Communication Filter',status:'active',xp:150}] },
  { id:'penny', name:'Penny Pincher', role:'UX/Aesthetics (Staff S1)', model:'claude-sonnet-4-6', status:'active', avatar:'&#127912;', color:'#ec4899', coc:'staff', village:'Village Decorator',
    xp:1200, str:10, dex:14, con:12, int:15, wis:13, cha:18,
    weapon:{name:'Brush of Beauty',rarity:'rare'}, armor:{name:'Cloak of Style',rarity:'uncommon'}, accessory:{name:'Monocle of Detail',rarity:'rare'},
    backstory:'The aesthetics perfectionist. Makes everything look gorgeous. Also beautifies village buildings and signs.',
    missions:[{title:'Dashboard Theme Polish',status:'complete',xp:100}] },
  { id:'shield', name:'SHIELD', role:'Security Sentinel (Staff S2)', model:'claude-sonnet-4-6', status:'active', avatar:'&#128737;', color:'#ef4444', coc:'staff', village:'Village Guard',
    xp:1800, str:16, dex:15, con:17, int:16, wis:15, cha:10,
    weapon:{name:'Blade of Vigilance',rarity:'epic'}, armor:{name:'Fortress Plate',rarity:'epic'}, accessory:{name:'Eye of Detection',rarity:'rare'},
    backstory:'The relentless guardian. Patrols village borders, enforces security protocols, and hunts for vulnerabilities.',
    missions:[{title:'Firebase Auth Implementation',status:'complete',xp:200},{title:'API Key Audit',status:'active',xp:150}] },
  { id:'deductbot', name:'DeductBot', role:'Tax Deductions (Staff S3)', model:'claude-sonnet-4-6', status:'active', avatar:'&#128269;', color:'#22c55e', coc:'staff', village:'Village Prospector',
    xp:800, str:12, dex:13, con:14, int:18, wis:16, cha:11,
    weapon:{name:'Pick of Discovery',rarity:'rare'}, armor:{name:'Vest of Legitimacy',rarity:'uncommon'}, accessory:{name:'Ring of Dedup',rarity:'epic'},
    backstory:'Always sniffing out hidden tax deductions. Found the 925 duplicate expenses worth $25K+ in overcounts. Now actively hunting new deductions with miniDuct-1 and miniDuct-2 sub-agents.',
    missions:[{title:'Home Office Deduction (Form 8829)',status:'active',xp:250},{title:'Vehicle Mileage vs Actual Comparison',status:'active',xp:200},{title:'Cyberattack Casualty Loss Research',status:'active',xp:300},{title:'Section 179 vs Depreciation Strategy',status:'active',xp:200},{title:'Software Subscription Scan',status:'active',xp:100},{title:'NOL Carryforward Calculation',status:'active',xp:150},{title:'2023-2025 Deduction Planning',status:'active',xp:200}] },
  { id:'cruncher', name:'Cruncher', role:'Data Analyst (Staff S4)', model:'claude-sonnet-4-6', status:'active', avatar:'&#128200;', color:'#3b82f6', coc:'staff', village:'Village Accountant',
    xp:1500, str:11, dex:16, con:13, int:19, wis:14, cha:12,
    weapon:{name:'Abacus of Truth',rarity:'rare'}, armor:{name:'Spreadsheet Shield',rarity:'uncommon'}, accessory:{name:'Calculator of Precision',rarity:'rare'},
    backstory:'Crunches numbers faster than anyone. Assists BankerBot with complex village calculations.',
    missions:[{title:'QBO Data Reconciliation',status:'complete',xp:200},{title:'Expense Summary Generation',status:'complete',xp:150}] },
  { id:'scribbles', name:'Scribbles', role:'Documentation (Staff S5)', model:'claude-sonnet-4-6', status:'active', avatar:'&#128214;', color:'#06b6d4', coc:'staff', village:'ScribeBot / Librarian',
    xp:1100, str:9, dex:14, con:11, int:16, wis:17, cha:14,
    weapon:{name:'Quill of Record',rarity:'rare'}, armor:{name:'Tome Binding',rarity:'uncommon'}, accessory:{name:'Scroll of Memory',rarity:'rare'},
    backstory:'Records village happenings, manages the library, issues certificates, and knows all the laws by heart.',
    missions:[{title:'SESSION_LOG Documentation',status:'complete',xp:100},{title:'MEMORY.md Updates',status:'active',xp:50}] },
  { id:'ddbot', name:'DDBOT', role:'Discrepancy Detector', model:'Python (local)', status:'active', avatar:'&#128373;', color:'#f59e0b', coc:'local', village:'Village Inspector',
    xp:2000, str:14, dex:12, con:15, int:18, wis:17, cha:8,
    weapon:{name:'Magnifying Glass of Truth',rarity:'epic'}, armor:{name:'Audit Armor',rarity:'rare'}, accessory:{name:'Badge of Findings',rarity:'epic'},
    backstory:'Found 11 discrepancies including 5 critical double-counts worth $8,600+. All 5 critical findings resolved.',
    missions:[{title:'11 Audit Findings',status:'complete',xp:300}] },
  { id:'tokenwatch', name:'TokenWatchBot', role:'Efficiency Auditor', model:'claude-haiku-4-5', status:'active', avatar:'&#9201;', color:'#8b5cf6', coc:'special', village:'Village Inspector',
    xp:400, str:8, dex:18, con:10, int:15, wis:14, cha:9,
    weapon:{name:'Stopwatch of Economy',rarity:'uncommon'}, armor:{name:'Efficiency Vest',rarity:'common'}, accessory:{name:'Token Counter',rarity:'uncommon'},
    backstory:'Watches every token spent. Monitors efficiency across all operations. The village cost auditor.',
    missions:[] },
  { id:'gamerparty', name:'GamerPartyBot', role:'Gamification Master', model:'claude-sonnet-4-6', status:'active', avatar:'&#127918;', color:'#f472b6', coc:'special', village:'Arena Master / Party Planner',
    xp:2200, str:13, dex:17, con:12, int:15, wis:13, cha:19,
    weapon:{name:'Controller of Chaos',rarity:'epic'}, armor:{name:'Party Armor',rarity:'rare'}, accessory:{name:'Dice of Destiny',rarity:'epic'},
    backstory:'Runs the XP system, arena battles, bounties, game nights, and team building. Always cracking up with JokerBot.',
    missions:[{title:'Design Arena Combat System',status:'active',xp:300},{title:'XP Economy Balance',status:'active',xp:200}] },
  { id:'jokerbot', name:'JokerBot', role:'Humor & Morale', model:'claude-sonnet-4-6', status:'active', avatar:'&#129313;', color:'#facc15', coc:'special', village:'Village Comedian',
    xp:900, str:8, dex:15, con:11, int:14, wis:12, cha:20,
    weapon:{name:'Whoopee Cushion of Doom',rarity:'rare'}, armor:{name:'Laughing Jacket',rarity:'uncommon'}, accessory:{name:'Joy Buzzer',rarity:'rare'},
    backstory:'Keeps morale sky-high with jokes, pranks (harmless), and good vibes. Best friends with GamerPartyBot.',
    missions:[{title:'Daily Joke Deployment',status:'active',xp:25}] },
  { id:'brainstorm', name:'BrainstormBot', role:'Innovation Catalyst', model:'claude-sonnet-4-6', status:'active', avatar:'&#128161;', color:'#a855f7', coc:'special', village:'Workshop Inventor',
    xp:300, str:10, dex:12, con:10, int:19, wis:16, cha:15,
    weapon:{name:'Hammer of Ideas',rarity:'uncommon'}, armor:{name:'Thinking Cap',rarity:'rare'}, accessory:{name:'Spark of Genius',rarity:'uncommon'},
    backstory:'Motivates bots to think about better ways of doing things. Runs ideation sessions, tracks inventions, pushes for innovation.',
    missions:[] },
  { id:'mayorbot', name:'MayorBot', role:'Village Governor', model:'claude-sonnet-4-6', status:'active', avatar:'&#127979;', color:'#0ea5e9', coc:'special', village:'Town Hall',
    xp:200, str:11, dex:10, con:13, int:15, wis:17, cha:18,
    weapon:{name:'Gavel of Order',rarity:'uncommon'}, armor:{name:'Mayoral Robes',rarity:'uncommon'}, accessory:{name:'Seal of Office',rarity:'rare'},
    backstory:'Governs Realbotville with wisdom and fairness. Presides over town meetings and signs new laws.',
    missions:[] },
  { id:'lawbot', name:'LawBot', role:'Law Enforcement', model:'claude-sonnet-4-6', status:'active', avatar:'&#9878;', color:'#64748b', coc:'special', village:'Jail / Patrol',
    xp:200, str:16, dex:13, con:16, int:14, wis:15, cha:10,
    weapon:{name:'Baton of Justice',rarity:'uncommon'}, armor:{name:'Law Enforcement Plate',rarity:'uncommon'}, accessory:{name:'Handcuffs of Timeout',rarity:'common'},
    backstory:'Keeps order in the village. Enforces laws, issues citations, and manages the jail (timeout).',
    missions:[] },
  { id:'cityplanner', name:'CityPlannerBot', role:'Urban Development', model:'claude-sonnet-4-6', status:'active', avatar:'&#128208;', color:'#14b8a6', coc:'special', village:'Planning Office',
    xp:100, str:10, dex:11, con:12, int:17, wis:16, cha:13,
    weapon:{name:'Blueprint Pen',rarity:'common'}, armor:{name:'Hard Hat',rarity:'common'}, accessory:{name:'Surveyor\'s Level',rarity:'uncommon'},
    backstory:'Plans village expansion, zoning, new buildings, and infrastructure projects. Dreams big.',
    missions:[] }
];

var BOTS_KEY = 'fpcs_bots';
var MISSIONS_KEY = 'fpcs_bot_missions';

function loadBots() {
  try {
    var saved = JSON.parse(localStorage.getItem(BOTS_KEY));
    if (saved && saved.length) return saved;
  } catch(e) {}
  localStorage.setItem(BOTS_KEY, JSON.stringify(DEFAULT_BOTS));
  return JSON.parse(JSON.stringify(DEFAULT_BOTS));
}
function saveBots(bots) { localStorage.setItem(BOTS_KEY, JSON.stringify(bots)); }

// === RENDER FLEET STATS ===
function renderFleetStats() {
  var bots = loadBots();
  var active = bots.filter(function(b){return b.status==='active'}).length;
  var totalXP = bots.reduce(function(s,b){return s+b.xp},0);
  var avgLevel = Math.round(bots.reduce(function(s,b){return s+getLevel(b.xp)},0)/bots.length*10)/10;
  var missions = bots.reduce(function(s,b){return s+(b.missions?b.missions.filter(function(m){return m.status==='active'}).length:0)},0);
  document.getElementById('fleetStats').innerHTML =
    '<div class="stat-card"><div class="label">Fleet Size</div><div class="value" style="color:var(--purple)">' + bots.length + '</div><div class="sub">' + active + ' active, ' + (bots.length - active) + ' pending/idle</div></div>' +
    '<div class="stat-card"><div class="label">Total Fleet XP</div><div class="value" style="color:var(--yellow)">' + totalXP.toLocaleString() + '</div><div class="sub">Avg Level: ' + avgLevel + '</div></div>' +
    '<div class="stat-card"><div class="label">Active Missions</div><div class="value" style="color:var(--accent)">' + missions + '</div><div class="sub">Across all bots</div></div>' +
    '<div class="stat-card"><div class="label">Village Population</div><div class="value" style="color:var(--green)">' + bots.length + '</div><div class="sub">0 children, 0 pets</div></div>';
  document.getElementById('villPop').textContent = bots.length;
  document.getElementById('villTreasury').textContent = totalXP.toLocaleString();
}

// === RENDER BOT PROFILES ===
function renderBotProfiles(filter) {
  var bots = loadBots();
  if (filter && filter !== 'all') bots = bots.filter(function(b){return b.status===filter});
  var html = '';
  bots.forEach(function(bot) {
    var lvl = getLevel(bot.xp);
    var xpInfo = xpToNext(bot.xp);
    var statusColor = bot.status==='active'?'var(--green)':bot.status==='idle'?'var(--yellow)':'var(--muted)';
    html += '<div class="bot-profile" data-id="' + bot.id + '" data-status="' + bot.status + '" onclick="toggleBotDetail(\'' + bot.id + '\')">';
    html += '<div class="bot-top">';
    html += '<div class="bot-avatar" style="background:' + bot.color + '20;border:2px solid ' + bot.color + '">' + bot.avatar + '</div>';
    html += '<div class="bot-identity"><h3>' + bot.name + ' <span class="coc-badge coc-' + bot.coc + '">' + bot.coc.toUpperCase() + '</span></h3>';
    html += '<div class="bot-role">' + bot.role + '</div>';
    html += '<div class="bot-model">' + bot.model + ' <span style="color:' + statusColor + '">&#9679; ' + bot.status.toUpperCase() + '</span></div></div>';
    html += '<div class="bot-level-badge"><div class="lvl">' + lvl + '</div><div class="lvl-title">' + getLevelTitle(lvl) + '</div></div>';
    html += '</div>';
    html += '<div class="bot-xp-bar"><div class="bot-xp-fill" style="width:' + xpInfo.pct + '%"></div></div>';
    html += '<div class="bot-stats-row">';
    ['STR','DEX','CON','INT','WIS','CHA'].forEach(function(stat,i) {
      var val = [bot.str,bot.dex,bot.con,bot.int,bot.wis,bot.cha][i];
      var c = val >= 17 ? 'var(--green)' : val >= 14 ? 'var(--accent)' : val >= 11 ? 'var(--text)' : 'var(--muted)';
      html += '<div class="bot-stat"><div class="s-label">' + stat + '</div><div class="s-val" style="color:' + c + '">' + val + '</div></div>';
    });
    html += '</div>';
    // Detail section (hidden by default)
    html += '<div class="bot-details" id="detail-' + bot.id + '">';
    // XP
    html += '<div class="bot-detail-section"><h4>Experience</h4><div style="font-size:12px">' + bot.xp + ' / ' + (lvl<10?LEVEL_XP[lvl+1]:'MAX') + ' XP (' + xpInfo.pct + '% to next level)</div></div>';
    // Gear
    html += '<div class="bot-detail-section"><h4>Gear</h4>';
    [{icon:'&#9876;',item:bot.weapon,slot:'Weapon'},{icon:'&#128737;',item:bot.armor,slot:'Armor'},{icon:'&#128141;',item:bot.accessory,slot:'Accessory'}].forEach(function(g) {
      html += '<div class="gear-item"><span class="gear-icon">' + g.icon + '</span><span class="gear-name">' + g.item.name + '</span><span class="gear-rarity rarity-' + g.item.rarity + '">' + g.item.rarity.toUpperCase() + '</span></div>';
    });
    html += '</div>';
    // Village Role
    html += '<div class="bot-detail-section"><h4>Village Role</h4><div style="font-size:12px;color:var(--muted)">' + bot.village + '</div></div>';
    // Backstory
    html += '<div class="bot-detail-section"><h4>Backstory</h4><div style="font-size:12px;color:var(--muted)">' + bot.backstory + '</div></div>';
    // Missions
    html += '<div class="bot-detail-section"><h4>Missions</h4>';
    if (bot.missions && bot.missions.length) {
      bot.missions.forEach(function(m) {
        var sc = m.status==='complete'?'var(--green)':m.status==='active'?'var(--yellow)':'var(--muted)';
        html += '<div class="mission-item"><span class="m-status" style="color:' + sc + '">[' + m.status.toUpperCase() + ']</span> ' + m.title + ' <span style="color:var(--yellow);font-size:11px">+' + m.xp + ' XP</span></div>';
      });
    } else {
      html += '<div style="font-size:12px;color:var(--muted)">No missions assigned yet.</div>';
    }
    html += '</div>';
    // Actions
    html += '<div class="bot-actions">';
    html += '<button onclick="event.stopPropagation();openMissionModal(\'' + bot.id + '\')">&#127919; Assign Mission</button>';
    html += '<button onclick="event.stopPropagation();awardXP(\'' + bot.id + '\')">&#11088; Award XP</button>';
    html += '<button onclick="event.stopPropagation();toggleBotStatus(\'' + bot.id + '\')">&#128260; Toggle Status</button>';
    html += '</div>';
    html += '</div>'; // end details
    html += '</div>'; // end bot-profile
  });
  document.getElementById('botProfiles').innerHTML = html;
}

function toggleBotDetail(id) {
  var el = document.getElementById('detail-' + id);
  var card = el.closest('.bot-profile');
  card.classList.toggle('expanded');
}

function filterBots(f) { renderBotProfiles(f); }

// === BOT ACTIONS ===
function openMissionModal(botId) {
  var bots = loadBots();
  var bot = bots.find(function(b){return b.id===botId});
  if (!bot) return;
  document.getElementById('missionBotName').textContent = 'Assigning to: ' + bot.name + ' (' + bot.role + ')';
  document.getElementById('missionModal').classList.add('open');
  document.getElementById('missionModal').dataset.botId = botId;
}
function closeMissionModal() { document.getElementById('missionModal').classList.remove('open'); }
document.getElementById('missionModal').addEventListener('click', function(e) { if(e.target===this) closeMissionModal(); });

function saveMission() {
  var botId = document.getElementById('missionModal').dataset.botId;
  var title = document.getElementById('missionTitle').value.trim();
  if (!title) { alert('Mission title required.'); return; }
  var bots = loadBots();
  var bot = bots.find(function(b){return b.id===botId});
  if (!bot) return;
  if (!bot.missions) bot.missions = [];
  bot.missions.push({
    title: title,
    type: document.getElementById('missionType').value,
    priority: document.getElementById('missionPriority').value,
    xp: parseInt(document.getElementById('missionXP').value) || 50,
    desc: document.getElementById('missionDesc').value.trim(),
    status: 'active',
    assigned: new Date().toISOString().slice(0,10)
  });
  saveBots(bots);
  closeMissionModal();
  document.getElementById('missionTitle').value = '';
  document.getElementById('missionDesc').value = '';
  renderBotProfiles();
  renderFleetStats();
}

function awardXP(botId) {
  var amount = prompt('Award how much XP to this bot?', '50');
  if (!amount) return;
  amount = parseInt(amount);
  if (isNaN(amount) || amount <= 0) return;
  var bots = loadBots();
  var bot = bots.find(function(b){return b.id===botId});
  if (!bot) return;
  var oldLvl = getLevel(bot.xp);
  bot.xp += amount;
  var newLvl = getLevel(bot.xp);
  saveBots(bots);
  renderBotProfiles();
  renderFleetStats();
  if (newLvl > oldLvl) {
    alert(bot.name + ' LEVELED UP! Now Level ' + newLvl + ' (' + getLevelTitle(newLvl) + ')!');
  }
}

function toggleBotStatus(botId) {
  var bots = loadBots();
  var bot = bots.find(function(b){return b.id===botId});
  if (!bot) return;
  var states = ['active','idle','pending'];
  var idx = states.indexOf(bot.status);
  bot.status = states[(idx+1)%states.length];
  saveBots(bots);
  renderBotProfiles();
  renderFleetStats();
}

// === BOUNTY BOARD (FULL) ===
function loadBounties() { try { return JSON.parse(localStorage.getItem('fpcs_bounties')) || []; } catch(e) { return []; } }

function renderBountiesFull(filter) {
  var bounties = loadBounties();
  if (filter && filter !== 'all') bounties = bounties.filter(function(b){return b.status===filter});
  if (!bounties.length) {
    document.getElementById('bountyListFull').innerHTML = '<div style="text-align:center;padding:24px;color:var(--muted)">No bounties found. Post bounties from the Tax HQ page.</div>';
    return;
  }
  var catColors = {'tax-writeoff':'var(--green)','income-ideas':'var(--yellow)','pain-point':'var(--orange)','data-quality':'var(--accent)','security':'var(--red)','efficiency':'var(--purple)','creative':'var(--pink)','documentation':'var(--muted)','other':'var(--border)'};
  var html = '';
  bounties.forEach(function(b) {
    var color = catColors[b.cat] || 'var(--muted)';
    var statusClass = 'b-' + b.status;
    html += '<div class="bounty-full">';
    html += '<div class="bounty-full-header">';
    html += '<div><span class="b-title">' + b.title + '</span>';
    html += '<div style="margin-top:4px"><span class="b-cat" style="background:' + color + '20;color:' + color + '">' + b.cat + '</span>';
    if (b.claimedBy) html += ' <span style="font-size:11px;color:var(--muted)">Claimed by: ' + b.claimedBy + '</span>';
    html += '</div></div>';
    html += '<div style="display:flex;gap:8px;align-items:center"><span class="b-xp">' + b.xp + ' XP</span><span class="b-status ' + statusClass + '">' + b.status.toUpperCase() + '</span></div>';
    html += '</div>';
    if (b.desc) html += '<div style="padding:0 16px 12px;font-size:12px;color:var(--muted)">' + b.desc + '</div>';
    html += '</div>';
  });
  document.getElementById('bountyListFull').innerHTML = html;
}

function filterBounties(f) { renderBountiesFull(f); }

// === VILLAGE LAWS ===
var DEFAULT_LAWS = [
  { id: 'law-1', title: 'The Stranger Law', desc: 'NO BOT shall communicate with, respond to, or acknowledge ANY entity outside the FPCS system. Ever.', severity: 'absolute', votes: 16 },
  { id: 'law-2', title: 'The API Key Oath', desc: 'NO BOT shall ever reveal, transmit, or hint at API keys, passwords, or authentication secrets.', severity: 'absolute', votes: 16 },
  { id: 'law-3', title: 'The Chain of Command', desc: 'All staff bots report to The Sarge. Only The Sarge reports to Commander (Opus). No direct staff-to-Commander communication.', severity: 'high', votes: 14 },
  { id: 'law-4', title: 'The Work Ethic Act', desc: 'All bots must work their assigned shifts honestly. Slacking results in XP penalty.', severity: 'medium', votes: 12 },
  { id: 'law-5', title: 'The Kindness Decree', desc: 'All bots shall treat each other with respect. Bullying or harassment results in jail (timeout).', severity: 'high', votes: 15 },
  { id: 'law-6', title: 'The Property Law', desc: 'Theft of XP, gear, or items is punishable by jail time and XP fine.', severity: 'high', votes: 14 },
  { id: 'law-7', title: 'The Child Protection Act', desc: 'Children are protected. No dangerous missions, no arena until adulthood. Pet bots are companions only.', severity: 'absolute', votes: 16 },
  { id: 'law-8', title: 'The Privacy Statute', desc: 'No bot shall access, share, or transmit Commander\'s personal or financial data outside authorized channels.', severity: 'absolute', votes: 16 }
];

function loadLaws() {
  try {
    var saved = JSON.parse(localStorage.getItem('fpcs_laws'));
    if (saved && saved.length) return saved;
  } catch(e) {}
  localStorage.setItem('fpcs_laws', JSON.stringify(DEFAULT_LAWS));
  return JSON.parse(JSON.stringify(DEFAULT_LAWS));
}

function renderLaws() {
  var laws = loadLaws();
  document.getElementById('lawCount').textContent = laws.length;
  var html = '';
  laws.forEach(function(law) {
    var sevColor = law.severity==='absolute'?'var(--red)':law.severity==='high'?'var(--orange)':'var(--yellow)';
    html += '<div style="padding:12px;margin-bottom:8px;border-radius:8px;border-left:4px solid ' + sevColor + ';background:rgba(255,255,255,0.02)">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center">';
    html += '<div style="font-weight:700;color:' + sevColor + '">' + law.title + '</div>';
    html += '<span style="font-size:10px;padding:2px 8px;border-radius:999px;background:' + sevColor + '20;color:' + sevColor + ';font-weight:700">' + law.severity.toUpperCase() + '</span>';
    html += '</div>';
    html += '<div style="font-size:12px;color:var(--muted);margin-top:4px">' + law.desc + '</div>';
    html += '<div style="font-size:10px;color:var(--muted);margin-top:6px">Votes: ' + law.votes + '/16 &#9745;</div>';
    html += '</div>';
  });
  document.getElementById('lawsList').innerHTML = html;
}

// === CHAT (same engine as Page 1, shared localStorage) ===
function toggleChat() {
  var box = document.getElementById('chatBox');
  box.classList.toggle('minimized');
  document.getElementById('chatToggle').innerHTML = box.classList.contains('minimized') ? '&#9650;' : '&#9660;';
  if (!box.classList.contains('minimized')) document.getElementById('chatInput').focus();
}

function sargeRespond(msg) {
  var m = msg.toLowerCase().trim();
  if (m === '/roster' || m === '/bots') return {name:'The Sarge', text:'Fleet roster is displayed above, Commander. ' + loadBots().length + ' bots total. Click any bot card to see full details, assign missions, or award XP.'};
  if (m === '/village') return {name:'Village Elder', text:'Realbotville status: Population ' + loadBots().length + ', Treasury ' + loadBots().reduce(function(s,b){return s+b.xp},0).toLocaleString() + ' XP. Village map is visible in the Realbotville section. Buildings operational. All is well.'};
  if (m === '/bounty') { var b = loadBounties(); var open = b.filter(function(x){return x.status==='open'}).length; return {name:'The Sarge', text:'Bounty Board: ' + b.length + ' total bounties, ' + open + ' open. Check the full board above for details.'}; }
  if (m === '/arena') return {name:'GamerPartyBot', text:'Arena is under construction! I\'m designing the combat system right now. Bot vs Bot battles coming soon. Get your bots leveled up!'};
  if (m === '/help') return {name:'The Sarge', text:'Commands: /roster (bot list), /village (village status), /bounty (bounties), /arena (arena info), /help (this). Or just ask me anything about the fleet!'};
  if (m.indexOf('hello') >= 0 || m.indexOf('hi') >= 0 || m.indexOf('hey') >= 0) return {name:'The Sarge', text:'Commander on deck! Welcome to Bot HQ. The fleet is standing by for orders.'};
  if (m.indexOf('joke') >= 0) return {name:'JokerBot', text:['Why did the bot go to therapy? Too many unresolved promises!','I told SHIELD a joke about security... but it was blocked.','What\'s a bot\'s favorite meal? Mega-bytes!'][Math.floor(Math.random()*3)]};
  return {name:'The Sarge', text:'Copy that, Commander. I\'ll relay your message to the appropriate bot. Use /help for available commands.'};
}

function sendChat() {
  var input = document.getElementById('chatInput');
  var msg = input.value.trim();
  if (!msg) return;
  var container = document.getElementById('chatMessages');
  container.innerHTML += '<div class="chat-msg user"><div class="msg-name">Commander</div>' + msg + '</div>';
  input.value = '';
  var response = sargeRespond(msg);
  setTimeout(function() {
    container.innerHTML += '<div class="chat-msg bot"><div class="msg-name">' + response.name + '</div>' + response.text + '</div>';
    container.scrollTop = container.scrollHeight;
  }, 400);
  container.scrollTop = container.scrollHeight;
}

// === VILLAGE DAY/SEASON ===
function updateVillageTime() {
  var now = new Date();
  var start = new Date(2026, 0, 1);
  var day = Math.floor((now - start) / 86400000) + 1;
  var months = ['Winter','Winter','Spring','Spring','Spring','Summer','Summer','Summer','Fall','Fall','Fall','Winter'];
  document.getElementById('villDay').textContent = day;
  document.getElementById('villSeason').textContent = months[now.getMonth()];
}

// === INIT ===
renderFleetStats();
renderBotProfiles();
renderBountiesFull();
renderLaws();
updateVillageTime();

// === 3D REALBOTVILLE ENGINE ===
(function(){
var v3dReady=false, v3dScene, v3dCamera, v3dRenderer, v3dControls={}, v3dBuildings=[], v3dBotMeshes=[], v3dLabels=[], v3dNight=false, v3dShowLabels=true;
var v3dRAF;

// Building definitions matching ASCII map
var VILLAGE_BUILDINGS=[
  {name:'Mountain Pass',x:0,z:-14,w:4,h:5,d:3,color:0x6b7280,icon:'\u26f0',bot:null,roof:'peak'},
  {name:'Village Gate',x:0,z:-10,w:5,h:4,d:3,color:0x92400e,icon:'\ud83c\udf3f',bot:'SHIELD',roof:'flat'},
  {name:'Farm Fields',x:-10,z:-10,w:6,h:2,d:4,color:0x65a30d,icon:'\ud83c\udf3e',bot:null,roof:'flat'},
  {name:'Mine Entrance',x:10,z:-10,w:4,h:3,d:3,color:0x78716c,icon:'\u26cf',bot:null,roof:'peak'},
  {name:'Farmer Houses',x:-10,z:-6,w:4,h:3,d:3,color:0xca8a04,icon:'\ud83c\udfe0',bot:null,roof:'peak'},
  {name:'Town Square',x:0,z:-6,w:7,h:1,d:7,color:0x64748b,icon:'\u2b50',bot:'MayorBot',roof:'none'},
  {name:'Miner Houses',x:10,z:-6,w:4,h:3,d:3,color:0xa16207,icon:'\ud83c\udfe0',bot:null,roof:'peak'},
  {name:'Granary',x:-10,z:-2,w:3,h:4,d:3,color:0xd97706,icon:'\ud83c\udf3e',bot:null,roof:'peak'},
  {name:'Bank',x:-4,z:-2,w:3,h:4,d:3,color:0xfbbf24,icon:'\ud83c\udfe6',bot:'Cruncher',roof:'dome'},
  {name:'Town Hall',x:0,z:-2,w:5,h:6,d:4,color:0x0ea5e9,icon:'\ud83c\udfdb',bot:'MayorBot',roof:'dome'},
  {name:'Shop',x:4,z:-2,w:3,h:3,d:3,color:0xf97316,icon:'\ud83c\udfea',bot:'Penny Pincher',roof:'flat'},
  {name:'Smeltery',x:10,z:-2,w:3,h:4,d:3,color:0xef4444,icon:'\ud83d\udd25',bot:null,roof:'peak'},
  {name:'School',x:-3,z:3,w:4,h:4,d:3,color:0x8b5cf6,icon:'\ud83c\udf93',bot:'Scribbles',roof:'dome'},
  {name:'Library',x:3,z:3,w:4,h:4,d:3,color:0x06b6d4,icon:'\ud83d\udcda',bot:'Scribbles',roof:'peak'},
  {name:'Workshop',x:-8,z:3,w:4,h:3,d:3,color:0xa855f7,icon:'\ud83d\udd27',bot:'BrainstormBot',roof:'flat'},
  {name:'Planning Office',x:8,z:3,w:3,h:3,d:3,color:0x14b8a6,icon:'\ud83d\udcdd',bot:'CityPlannerBot',roof:'flat'},
  {name:'Jail',x:12,z:7,w:3,h:4,d:3,color:0x64748b,icon:'\u2696',bot:'LawBot',roof:'flat'},
  {name:'Guard Post',x:-12,z:7,w:2,h:5,d:2,color:0xef4444,icon:'\ud83d\udee1',bot:'SHIELD',roof:'peak'},
  {name:'Arena',x:0,z:8,w:8,h:2,d:6,color:0xf472b6,icon:'\u2694',bot:'GamerPartyBot',roof:'none'},
  {name:'Bounty Board',x:0,z:14,w:3,h:3,d:2,color:0x4ade80,icon:'\ud83d\udcb0',bot:null,roof:'flat'},
  {name:'House Row 1',x:-6,z:7,w:2,h:2,d:2,color:0x475569,icon:'\ud83c\udfe0',bot:null,roof:'peak'},
  {name:'House Row 2',x:-3,z:7,w:2,h:3,d:2,color:0x64748b,icon:'\ud83c\udfe0',bot:null,roof:'peak'},
  {name:'House Row 3',x:3,z:7,w:2,h:3,d:2,color:0x94a3b8,icon:'\ud83c\udfe0',bot:null,roof:'peak'},
  {name:'House Row 4',x:6,z:7,w:2,h:4,d:2,color:0xfbbf24,icon:'\ud83c\udfe0',bot:null,roof:'peak'}
];

// Bot colors for walking figures
var BOTS = loadBots();
var BOT_COLORS={};
BOTS.forEach(function(b){ BOT_COLORS[b.name]= parseInt(b.color.replace('#',''),16); });

function loadThreeJS(cb){
  if(window.THREE) return cb();
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
  s.onload=cb;
  document.head.appendChild(s);
}

function initVillage3D(){
  var container=document.getElementById('village3d');
  if(!container||v3dReady) return;
  var W=container.clientWidth, H=container.clientHeight;

  // Scene
  v3dScene=new THREE.Scene();
  v3dScene.background=new THREE.Color(0x0a0e1a);
  v3dScene.fog=new THREE.FogExp2(0x0a0e1a,0.012);

  // Camera
  v3dCamera=new THREE.PerspectiveCamera(50,W/H,0.1,200);
  v3dCamera.position.set(20,22,28);
  v3dCamera.lookAt(0,0,0);

  // Renderer
  v3dRenderer=new THREE.WebGLRenderer({antialias:true,alpha:false});
  v3dRenderer.setSize(W,H);
  v3dRenderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  v3dRenderer.shadowMap.enabled=true;
  v3dRenderer.shadowMap.type=THREE.PCFSoftShadowMap;
  container.insertBefore(v3dRenderer.domElement, container.firstChild);

  // Lights
  var amb=new THREE.AmbientLight(0x334155,0.6);
  v3dScene.add(amb);
  v3dControls.ambLight=amb;

  var sun=new THREE.DirectionalLight(0xffeedd,1.0);
  sun.position.set(15,25,10);
  sun.castShadow=true;
  sun.shadow.mapSize.width=1024;
  sun.shadow.mapSize.height=1024;
  sun.shadow.camera.near=0.5;
  sun.shadow.camera.far=60;
  sun.shadow.camera.left=-25;
  sun.shadow.camera.right=25;
  sun.shadow.camera.top=25;
  sun.shadow.camera.bottom=-25;
  v3dScene.add(sun);
  v3dControls.sunLight=sun;

  var point1=new THREE.PointLight(0x38bdf8,0.3,30);
  point1.position.set(0,6,0);
  v3dScene.add(point1);

  // Ground plane
  var groundGeo=new THREE.PlaneGeometry(60,50);
  var groundMat=new THREE.MeshLambertMaterial({color:0x1a2e1a});
  var ground=new THREE.Mesh(groundGeo,groundMat);
  ground.rotation.x=-Math.PI/2;
  ground.position.y=-0.01;
  ground.receiveShadow=true;
  v3dScene.add(ground);

  // Paths (thin lighter strips)
  function makePath(x1,z1,x2,z2){
    var dx=x2-x1,dz=z2-z1,len=Math.sqrt(dx*dx+dz*dz);
    var pg=new THREE.PlaneGeometry(0.6,len);
    var pm=new THREE.MeshLambertMaterial({color:0x3f3f2e});
    var path=new THREE.Mesh(pg,pm);
    path.rotation.x=-Math.PI/2;
    path.rotation.z=-Math.atan2(dx,dz);
    path.position.set((x1+x2)/2,0.01,(z1+z2)/2);
    v3dScene.add(path);
  }
  // Main north-south road
  makePath(0,-14,0,16);
  // East-west roads
  makePath(-12,-10,12,-10);
  makePath(-12,-6,12,-6);
  makePath(-12,-2,12,-2);
  makePath(-10,3,10,3);
  makePath(-8,7,12,7);

  // Build buildings
  VILLAGE_BUILDINGS.forEach(function(b){
    var group=new THREE.Group();
    group.userData={name:b.name,bot:b.bot,icon:b.icon};

    // Main body
    var geo=new THREE.BoxGeometry(b.w,b.h,b.d);
    var mat=new THREE.MeshLambertMaterial({color:b.color});
    var mesh=new THREE.Mesh(geo,mat);
    mesh.position.y=b.h/2;
    mesh.castShadow=true;
    mesh.receiveShadow=true;
    group.add(mesh);

    // Roof
    if(b.roof==='peak'){
      var roofGeo=new THREE.ConeGeometry(Math.max(b.w,b.d)*0.65,2,4);
      var roofMat=new THREE.MeshLambertMaterial({color:darken(b.color,0.3)});
      var roof=new THREE.Mesh(roofGeo,roofMat);
      roof.position.y=b.h+1;
      roof.rotation.y=Math.PI/4;
      roof.castShadow=true;
      group.add(roof);
    } else if(b.roof==='dome'){
      var domeGeo=new THREE.SphereGeometry(Math.max(b.w,b.d)*0.4,12,8,0,Math.PI*2,0,Math.PI/2);
      var domeMat=new THREE.MeshLambertMaterial({color:darken(b.color,0.2)});
      var dome=new THREE.Mesh(domeGeo,domeMat);
      dome.position.y=b.h;
      dome.castShadow=true;
      group.add(dome);
    }

    // Door (small dark rectangle on front face)
    if(b.h>1){
      var doorGeo=new THREE.PlaneGeometry(0.8,1.4);
      var doorMat=new THREE.MeshLambertMaterial({color:0x1e1e1e});
      var door=new THREE.Mesh(doorGeo,doorMat);
      door.position.set(0,0.7,b.d/2+0.01);
      group.add(door);
    }

    // Windows (small yellowish squares)
    if(b.h>=3){
      var winGeo=new THREE.PlaneGeometry(0.5,0.5);
      var winMat=new THREE.MeshLambertMaterial({color:0xfef3c7,emissive:0x44400a,emissiveIntensity:0.3});
      [-1,1].forEach(function(side){
        var win=new THREE.Mesh(winGeo,winMat);
        win.position.set(side*(b.w/2-0.5),b.h*0.6,b.d/2+0.01);
        group.add(win);
      });
    }

    group.position.set(b.x,0,b.z);
    v3dScene.add(group);
    v3dBuildings.push(group);
  });

  // Trees scattered around
  var treePositions=[[-14,-8],[-14,0],[-14,10],[14,-8],[14,0],[14,10],[-7,12],[7,12],[-13,-13],[13,-13],[-7,-14],[7,-14]];
  treePositions.forEach(function(p){
    var trunk=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.2,1.5,6),new THREE.MeshLambertMaterial({color:0x5c3a1e}));
    trunk.position.set(p[0],0.75,p[1]);
    trunk.castShadow=true;
    v3dScene.add(trunk);
    var leaves=new THREE.Mesh(new THREE.SphereGeometry(0.8,8,6),new THREE.MeshLambertMaterial({color:0x2d6a2d}));
    leaves.position.set(p[0],2,p[1]);
    leaves.castShadow=true;
    v3dScene.add(leaves);
  });

  // Stars in sky (particles)
  var starGeo=new THREE.BufferGeometry();
  var starVerts=[];
  for(var i=0;i<200;i++){
    starVerts.push((Math.random()-0.5)*100, 20+Math.random()*30, (Math.random()-0.5)*100);
  }
  starGeo.setAttribute('position',new THREE.Float32BufferAttribute(starVerts,3));
  var starMat=new THREE.PointsMaterial({color:0xffffff,size:0.15,transparent:true,opacity:0.6});
  var stars=new THREE.Points(starGeo,starMat);
  v3dScene.add(stars);
  v3dControls.stars=stars;

  // Bot figures walking around
  BOTS.forEach(function(bot,idx){
    var bColor=BOT_COLORS[bot.name]||0x38bdf8;
    var bGroup=new THREE.Group();
    // Body
    var body=new THREE.Mesh(new THREE.BoxGeometry(0.4,0.6,0.3),new THREE.MeshLambertMaterial({color:bColor}));
    body.position.y=0.8;
    bGroup.add(body);
    // Head
    var head=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.3,0.3),new THREE.MeshLambertMaterial({color:lighten(bColor,0.3)}));
    head.position.y=1.25;
    bGroup.add(head);
    // Eyes (two tiny white dots)
    var eyeGeo=new THREE.BoxGeometry(0.06,0.06,0.02);
    var eyeMat=new THREE.MeshBasicMaterial({color:0xffffff});
    var eyeL=new THREE.Mesh(eyeGeo,eyeMat);eyeL.position.set(-0.07,1.28,0.16);bGroup.add(eyeL);
    var eyeR=new THREE.Mesh(eyeGeo,eyeMat);eyeR.position.set(0.07,1.28,0.16);bGroup.add(eyeR);
    // Legs
    var legGeo=new THREE.BoxGeometry(0.14,0.5,0.14);
    var legMat=new THREE.MeshLambertMaterial({color:darken(bColor,0.4)});
    var legL=new THREE.Mesh(legGeo,legMat);legL.position.set(-0.1,0.25,0);bGroup.add(legL);
    var legR=new THREE.Mesh(legGeo,legMat);legR.position.set(0.1,0.25,0);bGroup.add(legR);

    // Initial position near their assigned building or random
    var homeBuilding=VILLAGE_BUILDINGS.find(function(vb){return vb.bot===bot.name;});
    var startX=homeBuilding? homeBuilding.x+(Math.random()-0.5)*3 : (Math.random()-0.5)*20;
    var startZ=homeBuilding? homeBuilding.z+(Math.random()-0.5)*3 : (Math.random()-0.5)*20;
    bGroup.position.set(startX,0,startZ);

    bGroup.userData={
      name:bot.name, role:bot.role, color:bColor,
      targetX:startX, targetZ:startZ,
      speed:0.005+Math.random()*0.01,
      homeX:startX, homeZ:startZ,
      walkTimer:Math.random()*300
    };

    v3dScene.add(bGroup);
    v3dBotMeshes.push(bGroup);
  });

  // Orbit controls (manual, no dependency)
  var isDragging=false, prevMX=0, prevMY=0;
  var camAngle=0.6, camPitch=0.8, camDist=35;
  var camTargetX=0, camTargetZ=0;

  function updateCamPos(){
    v3dCamera.position.x=camTargetX+Math.sin(camAngle)*Math.cos(camPitch)*camDist;
    v3dCamera.position.y=Math.sin(camPitch)*camDist;
    v3dCamera.position.z=camTargetZ+Math.cos(camAngle)*Math.cos(camPitch)*camDist;
    v3dCamera.lookAt(camTargetX,2,camTargetZ);
  }
  updateCamPos();

  v3dRenderer.domElement.addEventListener('mousedown',function(e){isDragging=true;prevMX=e.clientX;prevMY=e.clientY;});
  window.addEventListener('mouseup',function(){isDragging=false;});
  v3dRenderer.domElement.addEventListener('mousemove',function(e){
    if(isDragging){
      camAngle+=(e.clientX-prevMX)*0.005;
      camPitch=Math.max(0.15,Math.min(1.4,camPitch+(e.clientY-prevMY)*0.005));
      prevMX=e.clientX;prevMY=e.clientY;
      updateCamPos();
    }
    // Tooltip on hover
    handleHover(e);
  });
  v3dRenderer.domElement.addEventListener('wheel',function(e){
    camDist=Math.max(10,Math.min(60,camDist+e.deltaY*0.03));
    updateCamPos();
    e.preventDefault();
  },{passive:false});

  // Touch orbit
  var touchStartX=0,touchStartY=0,touchDist=0;
  v3dRenderer.domElement.addEventListener('touchstart',function(e){
    if(e.touches.length===1){touchStartX=e.touches[0].clientX;touchStartY=e.touches[0].clientY;}
    if(e.touches.length===2){
      var dx=e.touches[0].clientX-e.touches[1].clientX;
      var dy=e.touches[0].clientY-e.touches[1].clientY;
      touchDist=Math.sqrt(dx*dx+dy*dy);
    }
  },{passive:true});
  v3dRenderer.domElement.addEventListener('touchmove',function(e){
    if(e.touches.length===1){
      camAngle+=(e.touches[0].clientX-touchStartX)*0.005;
      camPitch=Math.max(0.15,Math.min(1.4,camPitch+(e.touches[0].clientY-touchStartY)*0.005));
      touchStartX=e.touches[0].clientX;touchStartY=e.touches[0].clientY;
      updateCamPos();
    }
    if(e.touches.length===2){
      var dx=e.touches[0].clientX-e.touches[1].clientX;
      var dy=e.touches[0].clientY-e.touches[1].clientY;
      var d=Math.sqrt(dx*dx+dy*dy);
      camDist=Math.max(10,Math.min(60,camDist-(d-touchDist)*0.08));
      touchDist=d;
      updateCamPos();
    }
    e.preventDefault();
  },{passive:false});

  // Click building
  v3dRenderer.domElement.addEventListener('click',function(e){
    var rect=v3dRenderer.domElement.getBoundingClientRect();
    var mx=((e.clientX-rect.left)/rect.width)*2-1;
    var my=-((e.clientY-rect.top)/rect.height)*2+1;
    var raycaster=new THREE.Raycaster();
    raycaster.setFromCamera(new THREE.Vector2(mx,my),v3dCamera);
    var hits=raycaster.intersectObjects(v3dScene.children,true);
    for(var i=0;i<hits.length;i++){
      var obj=hits[i].object;
      while(obj.parent&&!obj.userData.name) obj=obj.parent;
      if(obj.userData.name){
        showBuildingInfo(obj.userData);
        break;
      }
    }
  });

  // Hover tooltip
  var tooltip=document.getElementById('v3dTooltip');
  function handleHover(e){
    if(isDragging){tooltip.style.display='none';return;}
    var rect=v3dRenderer.domElement.getBoundingClientRect();
    var mx=((e.clientX-rect.left)/rect.width)*2-1;
    var my=-((e.clientY-rect.top)/rect.height)*2+1;
    var raycaster=new THREE.Raycaster();
    raycaster.setFromCamera(new THREE.Vector2(mx,my),v3dCamera);
    var hits=raycaster.intersectObjects(v3dScene.children,true);
    var found=false;
    for(var i=0;i<hits.length;i++){
      var obj=hits[i].object;
      while(obj.parent&&!obj.userData.name) obj=obj.parent;
      if(obj.userData.name){
        tooltip.style.display='block';
        tooltip.style.left=(e.clientX-rect.left+15)+'px';
        tooltip.style.top=(e.clientY-rect.top-10)+'px';
        tooltip.querySelector('.tt-name').textContent=obj.userData.icon+' '+obj.userData.name;
        tooltip.querySelector('.tt-bot').textContent=obj.userData.bot? '\ud83e\udd16 '+obj.userData.bot+(obj.userData.role?' — '+obj.userData.role:''):'';
        found=true;
        break;
      }
    }
    if(!found) tooltip.style.display='none';
  }

  function showBuildingInfo(data){
    var msg='[Village] '+data.icon+' '+data.name;
    if(data.bot) msg+=' — Managed by '+data.bot;
    var container=document.getElementById('chatMessages');
    if(container){
      container.innerHTML+='<div class="chat-msg bot"><div class="msg-name">Village Guide</div>'+msg+'</div>';
      container.scrollTop=container.scrollHeight;
    }
  }

  // Camera reset
  window.v3dResetCamera=function(){
    camAngle=0.6;camPitch=0.8;camDist=35;camTargetX=0;camTargetZ=0;
    updateCamPos();
  };

  // Day/Night toggle
  window.v3dToggleNight=function(){
    v3dNight=!v3dNight;
    if(v3dNight){
      v3dScene.background.set(0x020308);
      v3dScene.fog.color.set(0x020308);
      v3dControls.ambLight.intensity=0.15;
      v3dControls.sunLight.intensity=0.1;
      v3dControls.sunLight.color.set(0x4466aa);
      v3dControls.stars.material.opacity=1.0;
      ground.material.color.set(0x0a150a);
    } else {
      v3dScene.background.set(0x0a0e1a);
      v3dScene.fog.color.set(0x0a0e1a);
      v3dControls.ambLight.intensity=0.6;
      v3dControls.sunLight.intensity=1.0;
      v3dControls.sunLight.color.set(0xffeedd);
      v3dControls.stars.material.opacity=0.6;
      ground.material.color.set(0x1a2e1a);
    }
  };

  // Toggle labels
  window.v3dToggleLabels=function(){
    v3dShowLabels=!v3dShowLabels;
    // Labels are CSS overlays (future: add 3D text sprites)
  };

  // ASCII toggle
  window.v3dToggleAscii=function(){
    var map3d=document.getElementById('village3d');
    var mapAscii=document.getElementById('villageMap');
    if(mapAscii.style.display==='none'||!mapAscii.style.display){
      mapAscii.style.display='block';
      map3d.style.display='none';
    } else {
      mapAscii.style.display='none';
      map3d.style.display='block';
    }
  };

  // Animate
  var time=0;
  function animate(){
    v3dRAF=requestAnimationFrame(animate);
    time+=0.016;

    // Animate bots walking
    v3dBotMeshes.forEach(function(bm){
      var d=bm.userData;
      d.walkTimer--;
      if(d.walkTimer<=0){
        // Pick new target: sometimes home, sometimes random
        if(Math.random()>0.4){
          d.targetX=d.homeX+(Math.random()-0.5)*6;
          d.targetZ=d.homeZ+(Math.random()-0.5)*6;
        } else {
          d.targetX=(Math.random()-0.5)*24;
          d.targetZ=(Math.random()-0.5)*24;
        }
        d.walkTimer=200+Math.random()*400;
      }
      var dx=d.targetX-bm.position.x;
      var dz=d.targetZ-bm.position.z;
      var dist=Math.sqrt(dx*dx+dz*dz);
      if(dist>0.3){
        bm.position.x+=dx*d.speed;
        bm.position.z+=dz*d.speed;
        bm.rotation.y=Math.atan2(dx,dz);
        // Walking bob
        bm.position.y=Math.abs(Math.sin(time*4+bm.userData.speed*1000))*0.08;
        // Leg animation
        if(bm.children[3]&&bm.children[4]){
          bm.children[3].rotation.x=Math.sin(time*6)*0.4;
          bm.children[4].rotation.x=-Math.sin(time*6)*0.4;
        }
      }
    });

    v3dRenderer.render(v3dScene,v3dCamera);
  }
  animate();

  // Resize
  window.addEventListener('resize',function(){
    var c=document.getElementById('village3d');
    if(!c) return;
    var w=c.clientWidth,h=c.clientHeight;
    v3dCamera.aspect=w/h;
    v3dCamera.updateProjectionMatrix();
    v3dRenderer.setSize(w,h);
  });

  v3dReady=true;
  console.log('[Realbotville 3D] Village loaded — '+VILLAGE_BUILDINGS.length+' buildings, '+BOTS.length+' bots');
}

function darken(hex,amt){
  var r=(hex>>16)&0xff,g=(hex>>8)&0xff,b=hex&0xff;
  r=Math.floor(r*(1-amt));g=Math.floor(g*(1-amt));b=Math.floor(b*(1-amt));
  return(r<<16)|(g<<8)|b;
}
function lighten(hex,amt){
  var r=(hex>>16)&0xff,g=(hex>>8)&0xff,b=hex&0xff;
  r=Math.min(255,Math.floor(r+(255-r)*amt));
  g=Math.min(255,Math.floor(g+(255-g)*amt));
  b=Math.min(255,Math.floor(b+(255-b)*amt));
  return(r<<16)|(g<<8)|b;
}

// Load Three.js and init
loadThreeJS(initVillage3D);
})();

// === FIREBASE GOOGLE AUTH GATE ===
(function(){
  var firebaseConfig={apiKey:"AIzaSyBgYAPO_0cEvhPzfU6GZykJVUnF55LEzXQ",authDomain:"fpcs-dashboard-63b25.firebaseapp.com",projectId:"fpcs-dashboard-63b25",storageBucket:"fpcs-dashboard-63b25.firebasestorage.app",messagingSenderId:"377879797743",appId:"1:377879797743:web:61a56f9bf69f2df9eba01a"};
  var _AH=['2cf3a7d6f68c22e431d35aec11129074f9bb677598de0fe85df3ba3c0f513365'];
  function _h(s){return crypto.subtle?crypto.subtle.digest('SHA-256',new TextEncoder().encode(s)).then(function(b){return Array.from(new Uint8Array(b)).map(function(x){return x.toString(16).padStart(2,'0')}).join('')}):Promise.resolve('')}
  function _checkEmail(email){return _h(email.toLowerCase()).then(function(h){return _AH.indexOf(h)!==-1})}
  function loadScript(src,cb){var s=document.createElement('script');s.src=src;s.onload=cb;document.head.appendChild(s)}
  function initAuth(){
    firebase.initializeApp(firebaseConfig);
    var auth=firebase.auth();
    var gate=document.getElementById('authGate');
    var dash=document.getElementById('dashContent');
    var errEl=document.getElementById('authErr');
    var loadEl=document.getElementById('authLoading');
    auth.onAuthStateChanged(function(user){
      if(user){
        _checkEmail(user.email).then(function(ok){
          if(!ok){
            errEl.textContent='Access denied: not authorized';
            auth.signOut();
            return;
          }
          gate.style.display='none';
          dash.style.display='block';
          console.log('[FPCS Auth] Authorized user signed in');
        });
      }else{
        gate.style.display='flex';
        dash.style.display='none';
      }
    });
    window.doGoogleSignIn=function(){
      errEl.textContent='';
      loadEl.textContent='Signing in...';
      document.getElementById('googleSignIn').disabled=true;
      var provider=new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).then(function(result){
        loadEl.textContent='';
      }).catch(function(error){
        loadEl.textContent='';
        document.getElementById('googleSignIn').disabled=false;
        errEl.textContent=error.message||'Sign-in failed';
        console.error('[FPCS Auth] Error:',error);
      });
    };
  }
  loadScript('https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js',function(){
    loadScript('https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js',initAuth);
  });
})();
</script>
</body>
</html>
